---
title: "00_main"
output: html_document
  html_document:
    theme: paper
    highlight: zenburn
    number_sections: true
    toc: true
    toc_float: 
      collapsed: true
      smooth_scroll: true
    df_print: paged
    # keep_md: true
  # md_document:
  #   variant: markdown_github
bibliography: bibliography.bib
---

```{r start_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Start

This document uses the `flowGraph` package to run experiments;
results are saved in the root `flowtype_metric` folder.

```{r start_flowGraph, message=FALSE, include=FALSE, echo=FALSE}
## load flowGraph package
# rstudioapi::openProject("/mnt/f/Brinkman group/current/Alice/flowGraph") # CHANGE THIS
install.packages("/mnt/FCS_local3/backup/Brinkman group/current/Alice/flowGraph",repos=NULL, type="source")
library(flowGraph)

## root directory; to put results in
root = "/mnt/FCS_local3/backup/Brinkman group/current/Alice/flowtype_metric" # CHANGE THIS
# root = "A:/school/grad/projects/flowtype_metric"
# setwd(root)

source(paste0(root,"/src/functions_generic.R"))
source(paste0(root,"/src/elbow.R"))

## libraries
libr(c("flowCore", "flowType", "RchyOptimyx",
       "doParallel", "foreach",
       "stringr", "furrr", "purrr",
       "plotly", "htmlwidgets", "ggpubr", "effsize", "visNetwork"))


## options
options(stringsAsFactors=FALSE)

## cores
no_cores = 1#detectCores()-1
# future::plan(future::multiprocess)

set.seed(1)
```


# Generate flowGraph objects for each data set

The code in this section takes a while to run; 
therefore they will not be evaluated, unless done so manually,
when running this document. Input data in this section can be found in the
`gating_projects` repository.

Briefly, the data sets are

- impc (ON-HOLD)
- class: gene (wildtype wt control gene & various knockout ko genes), gender; 
samples should be normalized based on ko genes

- flowcap-II aml [@aghaeepour2013critical]
- class: 43 aml (acute myeloid leukemia), 316 healthy subjects bone marrow or blood x 7 panels 
(1st panel is a control).
- we use the 6th panel with markers $SS$, $FS$, $HLA-DR$, $CD117$, $CD45$, $CD34$, and $CD38$.
- each sample has ~ 60,000 cells.
- $CD34+$ increases in aml subjects.

- genentech
- class: bone marrow and whole blood mixed and pure
- 2019-11-19 results based on a single random donor D
- singlets tube4: CD13+CD11c-
- singlets tube4 (suggested experimentally by GNE): CD13+CD16-
- earlier results based on 3 donors (1 is an outlier) greatest mean separation:
- my tube3: CD34+CD117+CD56-
- blasts tube4: CD13+CD16-cd11c-

- pregnancy [@aghaeepour2017immune]
- class: 4 time points of pregnancy, early, mid, late, 6 weeks postpartum x 18 and 10 women of the training and validation cohort
- analyzed on 13 markers ($CD123$, $CD14$, $CD16$, $CD3$, $CD4$, $CD45$, $CD45RA$, $CD56$, $CD66$, $CD7$, $CD8$, $Tbet$, $TCRgd$)
- each sample has ~ 300,000 cells
- Since discrepancies between subjects is a major batch effect, we further normalize for subject. For each subject, we take the calculated feature values of all of her samples and extract the difference between them and their mean.

- bodenmiller CyTOF [@bodenmiller2012multiplexed]
- human peripheral blood from 8 x 2 BCR-XL 
(b cell receptor / Fc receptor cross linker) un/stimulated healthy subjects
- 10 markers


## bodenmiller

Data obtained from the HDCytoDate package: 
e.g. Levine_32dim_SE(metadata = FALSE) Levine_32dim_flowSet(metadata = FALSE)

Remember to transform values; for cytof, usually use asinh with cofactor=5 
(cofactor=150 for flow cytometry). Below describes other data sets inside the package. Proceeding it, the code to preprocess the bodenmiller data set.

- Data sets to test clustering:
- Levine_32dim:
* cytof "Data-driven phenotypic dissection of AMLreveals progenitor-like 
cells that correlate with prognosis" 2015;
* human bone marrow cells from 2 healthy subjects H1, H2;
* (265627 (104184 manually gated, 161443 ungated) x cytof 32 surface markers)
* manually gated 14 cell populations
- Levine_13dim:
* cytof
* human bone marrow cells from 1 healthy subject
* (167044 (81747 manually gated, 85297 ungated) x 13 surface markers)
* manually gated 24 cell populations
- Samusik_01:
* (86864 (53173 manually gated, 33691 ungated) x 39 + ungated surface markers)
- Samusik_all:
* cytof "Automated mapping of phenotype space with single-cell data" 2016;
* mouse bone marrow from 10 C57BL/6J mice clones
* (841644 (514386 manually gated, 327258 ungated) x 39 surface markers)
* manually gated 24 + ungated cell populations
- Nilsson_rare:
* flow "Frequency determination of rare populations by flow cytometry: 
A hematopoietic stem cell perspective" 2013;
* human bone marrow cells from 1 healthy subject
* (44140 (358 manually gated hematopoietic stem cells) x 13 surface markers)
- Mosmann_rare:
* flow "SWIFT - Scalable clustering for automated identification of rare 
cell populations in large, high-dimensional flow cytometry datasets, 
Part 2: Biological evaluation" 2014
* human peripheral blood cells exposed to influenza agents from 1 healthy subject
* (296460 (109 manually gated rare activated cytokine producing 
memory CD4 T cells) x 14 (7 surface + 7 signalling) markers)

- Data sets to test differential analysis:
- Krieg_Anti_PD_1: strong batch effect, 2 different days ('batch23' and 'batch29')
* cytof "High-dimensional single-cell analysispredicts response to 
anti-PD-1 immunotherapy" 2018
* human peripheral blood from 20 melanoma skin cancer patients treated 
with anti-PD-1 immunotherapy x 2 days pre/post treatment (9/11 non/responders)
* CD14+CD16-HLA-DRhi monocytes (a small subpopulation of
CD14+CD33+HLA-DRhiICAM-1+CD64+CD141+CD86+CD11c+CD38+PD-L1+CD11b+ monocytes) 
prior to treatment is strong predictor of survival status following 
immunotherapy treatment.
* (85715 cells x 24 cell type markers (exclude CD45 b/c all cells show high so CD45=none)) 
- Bodenmiller_BCR_XL
* cytof "Multiplexed masscytometry profiling of cellular states perturbed 
by small-molecule regulators" 2012
* human peripheral blood from 8 x 2 BCR-XL 
(b cell receptor / Fc receptor cross linker) un/stimulated healthy subjects;
* differentially expressed signalling markers in many cell populations 
e.g. phosphorylated S6 (pS6) in B cells
* (172791 x 10 surface markers (cell type) + 14 
intracellular signalling functional markers (cell state))

```{r bodenmiller, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## input: gates + fcm files,  meta data paths
## output: feat/file-cell-count, meta_file

## input
input_dir = "/mnt/f/Brinkman group/current/Alice/gating_projects/HDCytoData_Bodenmiller"
data_dir = paste0(input_dir,"/data")
gate_dir = paste0(input_dir,"/gates")
fcs_dir = paste0(input_dir,"/fcs")
gate_dir = paste0(input_dir,"/gates")

## ouput
result_dir = paste0(root, "/results/bodenmiller"); 
dir.create(result_dir, showWarnings=FALSE, recursive=TRUE)


start = Sys.time()

## load data
load(paste0(fcs_dir,".Rdata")) # fslist; fcs files
meta_file0 = get(load(paste0(input_dir,"/meta_file.Rdata")))
load(paste0(input_dir,"/meta_mark.Rdata")) # meta_mark; markers in fcs
# load(paste0(data_dir,"/se.Rdata")) # se; data

## feat/file-count-count: flowtype
markers = c("CD3","CD4","CD20","CD33","CD14","IgM","CD7") # HLA-DR
gthresm = c("cd3.gate","cd4.gate","cd20.gate","cd33.gate",
            "cd14.gate","igm.gate","cd7.gate")
gatesfd = gates = get(load(paste0(gate_dir,"/gates.Rdata"))) #gates

# check data
for (i in 1:length(fslist)) {
    f = fslist[[i]]
    print(f@exprs[1:10,1])
}

## flowType
ftl = map(1:length(fslist), function(i) {
    flowType(Frame=fslist[[i]],
             PropMarkers=match(markers, meta_mark$marker_name),
             MarkerNames=markers,
             MaxMarkersPerPop=6, PartitionsPerMarker=2, Methods='Thresholds',
             Thresholds=as.list(gates[i,gthresm]),
             verbose=FALSE, MemLimit=60)
})

## prepare meta
meta_file = meta_file0[!duplicated(meta_file0$sample_id),-4]
for (ci in 1:ncol(meta_file))
    meta_file[,ci] = as.character(meta_file[,ci])
meta_file = as.data.frame(meta_file)
colnames(meta_file) = c("class","subject","id")
meta_file$class = gsub("reference","control",meta_file$class,ignore.case=TRUE)
meta_file$class[meta_file$class!="control"] = "exp"
meta_file = meta_file[match(names(fslist),meta_file$id),]
for (uc in unique(meta_file$class)) {
    uci = meta_file$class==uc
    meta_file$train[uci] = which(uci)%in%sample(which(uci),sum(uci)/2)
}

## save files
fg = flowGraph(ftl, no_cores=no_cores, meta=meta_file, #class="class",
               #label1="control", 
               # norm_path=paste0(result_dir,"/count_norm"),
               calculate_summary=FALSE)
               # path=paste0(result_dir,"/fg"))
# fg = fg_feat_mean_cls(fg, class="subject", no_cores=no_cores)

# fg <- fg_feat_mean_class(fg, class="subject", no_cores=1, 
#                          node_features=c("prop","SpecEnr"), edge_features="NONE")


save(fg, file=paste0(result_dir,"/fg.Rdata"))

time_output(start, "data_bodenmiller")
```


## EPIC HIPC

```{r epic, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
no_cores <- 15

## input directories
ft_dir <- "/mnt/f/FCS data/Tobias Kollmann/flowType_results/"
meta_dir <- "/mnt/f/Brinkman group/current/Alice/flowtype_metric/src/epichipc_20200318"

## get meta data
process_file <- function(file_path) {
    txt <- NULL
    con = file(file_path, "r")
    while (TRUE) {
        line = readLines(con, n=1)
        if (length(line)==0) break
        txt <- append(txt, line)
    }
    close(con)
    txt
}
meta_id <- process_file(paste0(meta_dir, "/meta_id.txt"))
meta_id <- gsub("[ \"]","",meta_id)
meta_id <- unlist(purrr::map(stringr::str_split(meta_id,"FCT"), function(x) 
    paste0("FCT",x[-1]) ))

meta_class <- process_file(paste0(meta_dir, "/meta_vaccine_response.txt"))
meta_class <- unlist(purrr::map(meta_class, stringr::str_extract_all, "negative|positive"))
meta_class[meta_class=="negative"] <- "control"

meta_cb <- process_file(paste0(meta_dir, "/meta_cells_ul_blood.txt"))
meta_cb <- unlist(purrr::map(meta_cb, stringr::str_extract_all, "[0-9]+[.][0-9]+"))
meta_cb <- as.numeric(meta_cb)

## load flowtype files and prepare count matrix (BCell panel only)
ft_paths <- list.files(ft_dir, recursive=TRUE, full.names=TRUE, pattern=".csv")
ft_paths <- ft_paths[grepl("Bcell",ft_paths)]
mcl <- unlist(purrr::map(ft_paths, function(x) {
    a <- read.csv(gsub("//","/",x))
    am <- as.character(a$samples_name)
    ua <- unique(am)
    b <- purrr::map(ua, function(y) a$cell_counts[am==y])
    names(b) <- ua
    b
}), recursive=FALSE)
inds <- match(meta_id, names(mcl))
mc <- do.call(rbind, mcl[inds])
rownames(mc) <- names(mcl)[inds]

temp <- read.csv(gsub("//","/",ft_paths[1]))
inds <- temp[,1]==temp[1,1]
phenocode <- stringr::str_pad(
    temp$Pheno_codes[inds],
    width=nchar(as.character(max(temp$Pheno_codes[inds]))), 
    side="left", pad="0")
phenotype <- as.character(temp$phenotype_names[inds])
phenotype[1] <- ""
phenotype <- gsub("NotSSCACD19", "SSCACD19-", phenotype)
phenotype <- gsub("NotSSCACD34", "SSCACD34-", phenotype)
phenotype <- gsub("NotCD38CD10", "CD38CD10-", phenotype)
phenotype <- gsub("SSCACD19[_]", "SSCACD19+", phenotype)
phenotype <- gsub("SSCACD34[_]", "SSCACD34+", phenotype)
phenotype <- gsub("CD38CD10[_]", "CD38CD10+", phenotype)
phenotype <- gsub("_","",phenotype)
colnames(mc) <- phenotype

# prepare flowGraph & add cells_ul_blood features
options(future.globals.maxSize=30000000000) #
fg <- flowGraph(mc, class=meta_class, no_cores=no_cores, calculate_summary=FALSE)
fg <- fg_add_feature(fg, type="node", feature="cells_ul_blood", m=meta_cb*fg@feat$node$prop)
fg <- fg_feat_node_specenr(fg, feature="cells_ul_blood")


# calculate summary statistics
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilcox",
#                  adjust_custom="none",
#                  diminish=FALSE,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilcox_diminish",
#                  adjust_custom="none",
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# 
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilcox_byLayer",
#                  class="vaccine_response",
#                  diminish=FALSE,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# fg <- fg_summary(fg, no_cores=no_cores,
#                  class="vaccine_response",
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# 
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilcox_BH",
#                  adjust_custom="BH",
#                  diminish=FALSE,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilcox_BH_diminish",
#                  adjust_custom="BH",
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# st <- function(x) tryCatch(stats::shapiro.test(x)$p.value, error=function(e) 0)
# test_custom <- function(x,y) {
#     if (st(x)>0.05 & st(y)>0.05)
#         return(tryCatch(stats::t.test(x,y)$p.value, error=function(e) 1))
#     return(tryCatch(stats::wilcox.test(x,y)$p.value, error=function(e) 1))
# }

# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt", adjust_custom="none",
#                  diminish=FALSE, test_custom=test_custom,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_diminish",
#                  adjust_custom="none",
#                  test_custom=test_custom,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# 
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_byLayer",
#                  test_custom=test_custom,
#                  diminish=FALSE,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_byLayer_diminish",
#                  test_custom=test_custom,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_BH",
#                  test_custom=test_custom,
#                  diminish=FALSE, adjust_custom="BH",
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)
# fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_BH_diminish",
#                  test_custom=test_custom,
#                  adjust_custom="BH",
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# mt <- function(x,y) tryCatch(stats::mood.test(x,y)$p.value, error=function(e) 1)
# fg <- fg_summary(fg, no_cores=no_cores, test_name="mood",
#                  test_custom=mt,
#                  adjust_custom="none", diminish=FALSE,
#                  node_features=c("prop","SpecEnr", "cells_ul_blood",
#                                  "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# qt <- function(x,y)
#     min( sum(x<.1 & x>-.1)/length(x), sum(y<.1 & y>-.1)/length(y))
# fg <- fg_summary(fg, no_cores=no_cores, test_name="test0",
#                  test_custom=qt,
#                  adjust_custom="none", diminish=FALSE,
#                  node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
#                  overwrite=FALSE)

# save
dir.create(paste0(root,"/results/epichipc_bcell"))
save(fg, file=paste0(root,"/results/epichipc_bcell/fg.Rdata"))
# save_fg(fg, paste0(root,"/results/epichipc_bcell/fg"))

```


## flowCap-II AML

This section preprocesses data from the flowCAP-II challenge AML data set comparing AML samples, healthy samples, and (generated below) mixed samples containing cells from AML and healthy samples.

```{r flowcap, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## input directories
fc_dir = "/mnt/f/Brinkman group/current/Alice/flowCAP-II"
ft_dir = paste0(fc_dir,"/data/FT") # flowtype file directory
csv_dir = paste0(fc_dir,"/meta_file.csv") # meta file directory
markers_dir = paste0(fc_dir,"/markers.Rdata") # fcs file directory

## output directories (NOT last section, output split by tube/panel)
result_dir0 = paste0(root, "/results/flowcap")

## options
matchsamples = 5 #pos: number of samples from each normal and aml to mix
amlprop = 1/2 #ctrl: proportion of control sample to make as "aml"


start = Sys.time()

## prepare flowtype directories
ft_dirs = sort( dir(ft_dir, pattern=".Rda", all.files=TRUE, full.names=TRUE, recursive=TRUE) )
ft_names = sapply(strsplit(ft_dirs,"/"), function(a) gsub(".Rda","",a[length(a)]) )

## prepare meta
meta_file0 = read.csv(csv_dir)[,-1]
for (i in 1:ncol(meta_file0))
    if (is.factor(meta_file0[,i]))
        meta_file0[,i] = as.character(meta_file0[,i])

markers = get(load(markers_dir))

# ## this or
# m00 = llply(loop_ind_f(1:length(ft_dirs),no_cores),function(ii)
#   llply(ii, function(i) get(load(ft_dirs[i]))@CellFreqs), .parallel=TRUE)
# m00 = as.matrix(Reduce('rbind',llply(m00,function(x)Reduce(rbind,x))))
# rownames(m00) = ft_names
# colnames(m00) = rownames(get(load(ft_dirs[1]))@MFIs)
# fg0 = flowGraph(m00, no_cores=no_cores, meta=meta_file0, normalize=FALSE, specenr=FALSE)

## that
fg0 = flowGraph(ft_dirs, no_cores=no_cores, meta=meta_file0, normalize=FALSE, specenr=TRUE, calculate_summary=FALSE)

## split by tube, add a mix class, and make a control only data set
randomindp = randomindc = NULL
for (tube in unique(meta_file0$tube)) {
    if (!tube==6) next
    
    ## split data by tube/panel
    fg = fg_extract_samples(fg0, fg0@meta$id[fg0@meta$tube==tube])
    fg = fg_gsub_ids(fg, as.numeric(gsub("T[0-9]S|FT","",fg@meta$id)) )
    # fg = fg_feat_node_norm(fg, no_cores=no_cores, norm_path=paste0(result_dir0, "_", tube, "/count_norm")) # normalize count
    marker = markers[[tube]]
    fg = fg_gsub_markers(fg, marker)
    
    mc = fg@feat$node$count_norm
    
    ## extract controls
    fg_c = fg_extract_samples(fg, fg@meta$id[fg@meta$class=="control"])
    fg_c@meta$class[1:(nrow(fg_c@meta)/2)] = "experiment"
    dir.create(paste0(result_dir0, "_", tube, "_ctrl"), showWarnings=FALSE)
    save(fg_c, file=paste0(result_dir0, "_", tube, "_ctrl/fg.Rdata"))
    
    
    ## make a new class: mixed
    normali = which(fg@meta$class=="control")
    amli = which(fg@meta$class=="aml")
    if (is.null(randomindp))
        for (i in 1:min(length(normali),length(amli))) {
            randomindp[[i]] = list()
            randomindp[[i]]$normal = sample(normali, matchsamples)
            randomindp[[i]]$aml = sample(amli, matchsamples)
        }
    weight = 1/(2*matchsamples)
    
    fg2 = fg
    for (nfeat in names(fg2@feat)) {
        for (nne in names(fg2@feat[[nfeat]])) {
            m = as.matrix(fg2@feat[[nfeat]][[nne]])
            mc2 = as.matrix(do.call(rbind, future_map(randomindp,function(ri)
                weight*colSums(m[append(ri$normal,ri$aml),,drop=FALSE]) )))
            rownames(mc2) = c((1+nrow(m)):(nrow(mc2)+nrow(m)))
            fg2@feat[[nfeat]][[nne]] = mc2
        }
    }
    
    # meta
    fg2@meta = meta2 = data.frame(
        class=rep("mix", length(randomindp)),
        id=rownames(mc2),
        train=append(rep(FALSE,floor(length(randomindp)/2)),
                     rep(TRUE,ceiling(length(randomindp)/2))),
        subject=0,
        tube=tube
    )
    fg1 = fg
    fg = fg_merge_samples(fg1, fg2)
    # fg <- fg_summary(fg, no_cores=no_cores, class="class",
    #                  label1="control",
    #                  node_features="SpecEnr",
    #                  edge_features="NONE",
    #                  overwrite=FALSE,
    #                  test_name=paste0("wilcox_byLayer_diminish"),
    #                  diminish=TRUE)
    
    dir.create(paste0(result_dir0, "_", tube), showWarnings=FALSE)
    # save_fg(fg, paste0(result_dir0, "_", tube, "/fg"))
    save(fg, file=paste0(result_dir0, "_", tube, "/fg.Rdata"))
}

time_output(start, "data_flowcap")
```


## genentech

This data set compares bone marrow and whole blood samples in incremental percentages from one random subject tested in genentech.

```{r genentech, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## input: genetech by daniel yokosawa on the genetech data (bone marrow + blood for 3 patients x 5 samples; computationally mixed)
## output: feat_file_cell_count, meta_file

## input directories
input_dir0 = "/mnt/f/Brinkman group/current/Alice/gating_projects/genentech"

start = Sys.time()

for (tube in 4){#2:4) {
    for (dtype in c("man","comp")) {
        input_dir = paste0(input_dir0,"/Tube_", str_pad(tube,3,"left",0),"/",dtype,"_mix")
        
        ## ouput directories
        result_dir = paste0(root, "/results/genentech_",tube,"_",dtype); dir.create(result_dir, showWarnings=FALSE, recursive=TRUE)
        
        start = Sys.time()
        
        ## prepare flowtype directories
        # ftl = get(load(paste0(input_dir,"/flowType_myeloid.Rdata")))
        ftl = get(load(paste0(input_dir,"/flowType_sing.Rdata")))
        names(ftl) = gsub("[%]","",names(ftl))
        markers = get(load(paste0(input_dir,"/MarkerNames_sing.Rdata")))
        
        ## prepare meta
        temp_ = str_extract(names(ftl),"[0-9]+BM")
        temp_[is.na(temp_)] = "control"
        meta_file = data.frame(id=names(ftl), class=temp_)
        for (uc in unique(meta_file$class)) {
            uci = meta_file$class==uc
            meta_file$train[uci] = which(uci)%in%sample(which(uci),sum(uci)/2)
        }
        
        fg = flowGraph(ftl, markers=markers, no_cores=no_cores, meta=meta_file,
                       label1="control", calculate_summary=FALSE)
        
        
        save(fg, file=paste0(result_dir,"/fg.Rdata"))
        
    }
    
}

time_output(start, "data_genetech")
```


## pregnancy

This data set compares womens' flow cytometry samples in their early, mid, late, and 6 weeks post-partum pregnancy stages

```{r pregnancy, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## input: gates + fcm files,  meta data paths
## output: feat_file_cell_count, meta_file
## process:
## - takes gates + fcm files, outputs flowtype vectors
## - compiles flowtype vectors together to create cell count matrix
## - reformats meta file (meta info for fcm files)
## - creates cell meta file (meta info for fcm cell populations)

## input directories
input_dir = "/mnt/f/Brinkman group/current/Alice/gating_projects/pregnancy"
meta_file_dir = paste0(input_dir, "/meta_file.Rdata")
flowtype_dir = paste0(input_dir, "/flowtype")

## ouput directories
result_dir0 = paste0(root, "/results/pregnancy"); dir.create(result_dir0, showWarnings=FALSE, recursive=TRUE)


start = Sys.time()

## prepare flowtype directories
ft_dirs = list.files(flowtype_dir, full.names=TRUE)
ft_names = sapply(strsplit(ft_dirs,"/"), function(a) gsub(".Rdata","",a[length(a)]) )
ft_names = gsub(".Rdata|.fcs|Gates_|_Unstim|_Repeat","",ft_names)
ft_names = gsub("BL","4",ft_names)

## prepare meta
meta_file0 = get(load(meta_file_dir))
colnames(meta_file0)[1] = "subject"
meta_file0 = meta_file0[match(ft_names, meta_file0$id),,drop=FALSE]
meta_file0$class[meta_file0$class==4] = "control"
meta_file0$train = ifelse(meta_file0$type=="train",TRUE,FALSE)
meta_file0 = meta_file0[,-4]

## feat/file-cell-count: load and compile flowtype count files
#  The total size of the 5 globals that need to be exported for the future expression (???.f()???) is 746.88 MiB. This exceeds the maximum allowed size of 500.00 MiB (option 'future.globals.maxSize'). The three largest globals are ‘ep??? (579.19 MiB of class ‘numeric???), ‘mp??? (102.64 MiB of class ‘numeric???) and ‘pparen??? (55.13 MiB of class ‘list???).
options(future.globals.maxSize=3000000000)
fg = flowGraph(ft_dirs, meta=meta_file0, no_cores=no_cores,
               calculate_summary=FALSE)
               # label1="control", norm_path=paste0(result_dir0,"/count_norm"))
# fg <- fg_feat_mean_class(fg, class="subject", no_cores=1, 
#                          node_features=c("prop","SpecEnr"), edge_features="NONE")

save(fg, file=paste0(result_dir0,"/fg.Rdata"))

time_output(start, "data_pregnancy")
```


## positive/negative control

artificially generated data sets.

```{r control, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## input: gates + fcm files,  meta data paths
## output: feat_file_cell_count, meta_file
## process:
## - takes gates + fcm files (values randomly generated via normal distribution; see different pos_ for how positive controls are changed
## - compiles flowtype vectors together to create cell count matrix
## - reformats meta file (meta info for fcm files)
## - creates cell meta file (meta info for fcm cell populations)

## options
nsample = 20 # of samples to create per data set; don't change this, i hard coded in cytodx and save fcm below on which files to use
nctrl = .5 # % of control samples
markern = 4 # # of markers
maxmarker = 6

normean = 300000 # 301234.7 for pregnancy
normsd = 0 # 64734.05 for pregnancy; if >0, remember to save as count not countAdj & run 01_feat_normalizeadj

lastlsdp = .1 # when generating only last layer cell proportions, use lastlsdp*normean/(2^markern) as sd

## cores
no_cores = 6


start = Sys.time()

# define number of cells in each fcs file
# for pregnancy data set, mean=301234.7, sd=64734.05
# ncells = floor(rnorm(nsample,300000,65000)) # number of cells for each sample
ncells = rnorm(nsample,normean,normsd) # number of cells for each sample

## meta/file
meta_file = data.frame(id=paste0("a",1:nsample), class="exp")
meta_file$class[1:(nctrl*nsample)] = "control"
meta_file$train = rep(FALSE,nrow(meta_file))
meta_file$train[(nctrl*nsample+1):(nctrl*nsample+(1-nctrl)*nsample/2)] = meta_file$train[1:(nctrl*nsample/2)] = TRUE

## prepare flowtype files
# load sample fcs file
# f = read.FCS("/mnt/f/Brinkman group/current/Alice/gating_projects/pregnancy/samplefcs.fcs")
f = new("flowFrame")

markers = LETTERS[1:markern] # markers

# marker thresholds
cvd = rnorm(ncells[1],2,1)
p50 = quantile(cvd, .5)
p60 = quantile(cvd, .6)
p75 = quantile(cvd, .75)
p25 = quantile(cvd, .25)
thress0 = purrr::map(markers, function(x) p50); names(thress0) = markers
# thress1 = thress2 = thress4 =
thress5 = thress0
# thress1[[markers[1]]] = thress2[markers[1:2]] = p25
# thress4[markers[1:4]] = quantile(cvd, .501)
thress5[[markers[1]]] = c(p25,p50)
thress5[[markers[2]]] = c(p25,p50,p60)

#paste0("ctrl",c(0:9)),
#paste0("pos",c(1:30))
# for (ds in c(paste0("pos",c(26,15,11,31,35,36,c(1:36)[-c(11,15,26,31,35,36)])))){#,paste0("ctrl",c(0:9)))) {
for (ds in paste0("pos",c(1:36))) {#,paste0("ctrl",c(0:9)))) {
    start2 = Sys.time()
    
    # ouput directories
    result_dir = paste0(root, "/results/",ds)
    fcs_dir = paste0(result_dir,"/fcs"); dir.create(fcs_dir, showWarnings=FALSE, recursive=TRUE)
    
    # make cell names
    f@exprs = matrix(rnorm(ncells[1]*length(markers),2,1),nrow=ncells[1])
    # a = flowType(Frame=f, PropMarkers=ci, MarkerNames=markers,
    #              MaxMarkersPerPop=min(markern,maxmarker), PartitionsPerMarker=2,
    #              Thresholds=thress0,
    #              Methods='Thresholds', verbose=FALSE, MemLimit=60)
    # ftcell = unlist(lapply(a@PhenoCodes, function(x){return( decodePhenotype(x, markers, a@PartitionsPerMarker) )}))
    # ftcell_ = str_count(ftcell,"[+|-]")
    # lastlcp = ftcell[ftcell_==length(markers)]
    # lastlcpm = llply(str_extract_all(lastlcp,"[A-Z][+|-]"), function(x)
    #   grepl("[+]",x) )
    # lastlallposi = which(sapply(lastlcpm, function(x) all(x)))
    # lastlallnegi = which(sapply(lastlcpm, function(x) all(!x)))
    
    # flowtype
    loop_ind = loop_ind_f(1:nsample,no_cores)
    ftl = future_map(loop_ind, function(ii) {
        future_map(ii, function(i) {
            # v1 randomized matrix
            f@exprs = matrix(rnorm(ncells[i]*markern,2,1), nrow=ncells[i])
            colnames(f@exprs) = markers
            ci = c(1:ncol(f@exprs)); names(ci) = colnames(f@exprs) # marker indices in f@exprs
            
            thress = thress0
            if (i>(nsample*nctrl) & grepl("pos",ds)) {
                # make base graph for plot
                # if (i == nsample*nctrl+1 & grepl("pos",ds)) {
                #   ft = flowType(Frame=f, PropMarkers=ci, MarkerNames=markers,
                #                 MaxMarkersPerPop=min(markern,maxmarker), PartitionsPerMarker=2,
                #                 Thresholds=thress,
                #                 Methods='Thresholds', verbose=FALSE, MemLimit=60)
                #   ftcell = unlist(lapply(ft@PhenoCodes, function(x)
                #     decodePhenotype(x, ft@MarkerNames, rep(2,length(ft@MarkerNames))) ))
                #   ftv0 = ftv0_ = ft@CellFreqs
                #   ftv0 = round(ftv0/ftv0[1],3)
                # }
                    dp = f@exprs[,4]>thress[[4]]
                    ap = f@exprs[,1]>thress[[1]]
                    bp = f@exprs[,2]>thress[[2]]
                    cp = f@exprs[,3]>thress[[3]]
                # ep = f@exprs[,5]>thress[[5]]
                double = ap & bp
                triple = ap & bp & cp
                quad   = ap & bp & cp & dp
                # quint = ap & bp & cp & dp & ep
                
                # change f values
                if (ds=="pos1") { # A+ > .75; A- > .25
                    tm = sum(ap)/2
                    f@exprs[sample(which(!ap),tm),1] = p75 #
                }
                else if (ds=="pos2") { # A+, B+ > .75; A-, B- > .25
                    tm = sum(ap)/2
                    f@exprs[sample(which(!ap),tm),1] = p75 #
                    f@exprs[sample(which(!bp),tm),2] = p75 #
                }
                else if (ds=="pos3") { # A-B+ > A+B+ x1.5
                    tm = sum(double)/2
                    f@exprs[sample(which(bp & !ap),tm),1] = p75 #
                    f@exprs[sample(which(ap & !bp),tm),1] = p25 #
                    f@exprs[sample(which(!ap & !bp),tm),1] = p25 #
                }
                else if (ds=="pos4") { # A-B+ > A+B+ x1.5; D+c- > D+c+ x1.5
                    tm = sum(double)/2
                    f@exprs[sample(which(bp & !ap),tm),1] = p75 #
                    f@exprs[sample(which(ap & !bp),tm),1] = p25 #
                    f@exprs[sample(which(!ap & !bp),tm),1] = p25 #
                    
                    f@exprs[sample(which(dp & !cp),tm),3] = p75 #
                    f@exprs[sample(which(cp & !dp),tm),3] = p25 #
                    f@exprs[sample(which(!dp & !cp),tm),3] = p25 #
                }
                else if (ds=="pos5") { # A-B+C+ > A+B+C+ x1.5
                    tm = sum(triple)/2
                    f@exprs[sample(which(bp & cp & !ap),tm),1] = p75 # A-B+C+ > A+B+C+
                    f@exprs[sample(which(ap & cp & !bp),tm),1] = p25 # A+B-C+ > A-B-C+
                    f@exprs[sample(which(ap & bp & !cp),tm),1] = p25 # A+B+C- > A-B+C-
                    f@exprs[sample(which(!ap & !bp & !cp),tm),1] = p75 # A-B-C- > A+B-C-
                }
                else if (ds=="pos6") { # A-B+C+ > A+B+C+ x1.5; b+D+c- > b+D+c+ x1.5
                    tm = sum(triple)/2
                    f@exprs[sample(which(bp & cp & !ap),tm),1] = p75 # bc
                    f@exprs[sample(which(ap & cp & !bp),tm),1] = p25 # ac
                    f@exprs[sample(which(ap & bp & !cp),tm),1] = p25 # ab
                    f@exprs[sample(which(!ap & !bp & !cp),tm),1] = p75 # a
                    
                    f@exprs[sample(which(bp & cp & !dp),tm),3] = p75 # bc
                    f@exprs[sample(which(bp & dp & !cp),tm),3] = p25 # ac
                    f@exprs[sample(which(dp & cp & !bp),tm),3] = p25 # ab
                    f@exprs[sample(which(!bp & !cp & !dp),tm),3] = p75 # a
                }
                else if (ds=="pos7") { # A+B+C+D+ > x2
                    tm = sum(bp & cp & dp & ap)/2
                    f@exprs[sample(which(bp & cp & dp & !ap),tm),1] = p75 # A-B+C+D+ > A+B+C+D+
                    f@exprs[sample(which(ap & cp & !bp),tm),1] = p25 # A+B-C+ > A-B-C+
                    f@exprs[sample(which(ap & bp & !cp),tm),1] = p25 # A+B+C- > A-B+C-
                    f@exprs[sample(which(!ap & !bp & !cp),tm),1] = p75 # A-B-C- > A+B-C-
                }
                else if (ds=="pos8") { # A-B-C-D-E- > x2
                    f@exprs = rbind(f@exprs, f@exprs[!ap & !bp & !cp & !dp,])
                }
                else if (ds=="pos9") { # same as above but both
                    f@exprs = rbind(
                        f@exprs, f@exprs[ap & bp & cp & dp,],
                        f@exprs[!ap & !bp & !cp & !dp,])
                }
                else if (ds=="pos10") { #1.5x A+, B+C+D+
                    inds <- c(sample(which(ap),sum(ap)/2),
                              sample(which(cp & dp & bp),sum(triple)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos11") { #1.5x A+
                    tm = sum(ap)
                    f@exprs = rbind(f@exprs,f@exprs[sample(which(ap),tm),])
                }
                else if (ds=="pos12") { #1.5x A+, B+
                    inds <- c(sample(which(ap),sum(ap)/2),
                              sample(which(bp),sum(bp)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos13") { #1.5x A+B+
                    tm = sum(double)/2
                    f@exprs = rbind(f@exprs,f@exprs[sample(which(ap & bp),tm),])
                }
                else if (ds=="pos14") { #1.5x A+B+, C+D+
                    tm = sum(double)/2
                    inds <- c(sample(which(ap & bp),tm),
                              sample(which(cp & dp),tm))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos15") { #1.5x A+B+C+
                    tm = sum(triple)/2
                    f@exprs = rbind(f@exprs, f@exprs[sample(which(ap & bp & cp),tm),])
                }
                else if (ds=="pos16") { #1.5x A+B+C+, B+C+D+
                    tm = sum(triple)/2
                    inds <- c(sample(which(ap & bp & cp),tm),
                              sample(which(bp & cp & dp),tm))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos17") { #1.5x A+B+C+D+, A+B+C+
                    inds <- c(sample(which(ap & bp & cp),sum(triple)/2),
                              sample(which(ap & bp & cp & dp),sum(ap & bp & cp & dp)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                # else if (ds=="pos17") { #1.5x A+B+; decrease other ones accordingly
                #     tm = .33*nrow(f@exprs) - sum(ap & bp) #sum(double)/3
                #     f@exprs[c(sample(which(!ap & !bp),tm/3) ,
                #               sample(which(ap & !bp),tm/3) ,
                #               sample(which(!ap & bp),tm/3)),c(1,2)] = p75
                # }
                else if (ds=="pos18") { #1.5x A+B+C+, C+D+
                    inds <- c(sample(which(ap & bp & cp),sum(triple)/2),
                              sample(which(cp & dp),sum(double)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                # else if (ds=="pos18") { #1.5x A+B+, C+D+, like above
                #     tm = sum(double)/2
                #     f@exprs[c(sample(which(!ap & !bp),tm/3) ,
                #               sample(which(ap & !bp),tm/3) ,
                #               sample(which(!ap & bp),tm/3)),c(1,2)] = p75
                # }
                else if (ds=="pos19") { #1.5x A+B+, B+C+
                    inds <- c(sample(which(ap & bp),sum(double)/2),
                              sample(which(cp & bp),sum(double)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos20") { #1.5x A+B+, C+D+
                    tm <- sum(double)/2
                    inds <- c(sample(which(ap & bp),tm),
                              sample(which(cp & dp),tm))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                }
                else if (ds=="pos21") { # 1.5x A+B+ - A-B-
                    tm = sum(double)/2
                    f@exprs = rbind(f@exprs[-sample(which(!ap & !bp),tm),],
                                    f@exprs[sample(which(ap & bp),tm/2),])
                }
                else if (ds=="pos22") { # 1.5x A+B+ - A+B-
                    tm = sum(double)/2
                    f@exprs = rbind(f@exprs[-sample(which(ap & !bp),tm),],
                                    f@exprs[sample(which(ap & bp),tm/2),])
                }
                else if (ds=="pos23") { #1.5x A+B+ A-B-
                    tm = sum(double)/2
                    f@exprs = rbind(f@exprs,
                                    f@exprs[sample(which(!ap & !bp),tm),],
                                    f@exprs[sample(which(ap & bp),tm/2),])
                }
                else if (ds=="pos24") { #1.5x A+B+, A+B-
                    tm = sum(double)/2
                    f@exprs = rbind(f@exprs,
                                    f@exprs[sample(which(ap & !bp),tm),],
                                    f@exprs[sample(which(ap & bp),tm/2),])
                }
                else if (ds=="pos25") {
                    tm = sum(triple)/2
                    f@exprs = f@exprs[-sample(which(ap & bp & cp),tm),]
                }
                else if (ds=="pos26") { #1.5x A+B+ D+
                    # tm = sum(dp)/2
                    # tripleind = which(dp)
                    # f@exprs = rbind(f@exprs,f@exprs[sample(tripleind,tm),])
                    # tm = sum(double)/2
                    # tripleind = which(ap & bp)
                    # f@exprs = rbind(f@exprs,f@exprs[sample(tripleind,tm),])
                    tm = sum(double)/2
                    inds <- c(sample(which(dp),sum(dp)/2),
                              sample(which(ap & bp),sum(ap & bp)/2))
                    inds <- inds[!duplicated(inds)]
                    f@exprs = rbind(f@exprs, f@exprs[inds,])
                    # tm = sum(double)/2
                    # tind = sample(which(bp & cp),tm)
                    # tind2 = sample(which(ap & bp),tm)
                    # f@exprs = f@exprs[-c(unique(c(tind,tind2))),]
                }
                else if (ds=="pos27") { #1.5x A+B+C+, B+C+D+
                    tm = sum(triple)/2
                    f@exprs = f@exprs[unique(c(which(ap & bp & cp),sample(which(cp & dp & bp),tm))),]
                }
                else if (ds=="pos28") { #1.5x - A+, - A+B+C+
                    tm = sum(triple)/2
                    tripleind = which(ap & bp & cp)
                    f@exprs = rbind(f@exprs,f@exprs[-unique(c(sample(which(ap & bp & cp),sum(triple)/2),sample(which(ap),sum(ap)/2))),])
                }
                
                else if (ds=="pos29") { #1.5x A+, B+C+D+
                    tm = sum(ap)/2
                    tripleind = which(ap)
                    f@exprs = rbind(f@exprs,f@exprs[sample(tripleind,tm),])
                    tm = sum(triple)/2
                    tripleind = which(cp & dp & bp)
                    f@exprs = rbind(f@exprs,f@exprs[sample(tripleind,tm),])
                }
                else if (ds=="pos30") { #A+B+ & D+ + 50%
                    tm = sum(triple)/2
                    tripleind = which(ap & bp & cp)
                    f@exprs = rbind(f@exprs,f@exprs[sample(tripleind,tm),])
                }
                else if (ds=="pos31") { #1.5x A+
                    tm = sum(double)
                    f@exprs = f@exprs[-sample(which(ap),tm),]
                }
                else if (ds=="pos32") { #1.5x A+, B+
                    tm = sum(double)
                    f@exprs = f@exprs[-unique(append(sample(which(ap),tm),
                                                     sample(which(bp),tm))),]
                }
                else if (ds=="pos33") { #1.5x A+B+
                    tm = sum(double)/2
                    f@exprs = f@exprs[-sample(which(ap & bp),tm),]
                }
                else if (ds=="pos34") { #1.5x A+B+, C+D+
                    tm = sum(double)/2
                    f@exprs = f@exprs[-unique(append(sample(which(ap & bp),tm),
                                                     sample(which(dp & cp),tm))),]
                }
                else if (ds=="pos35") { #1.5x A+B+C+
                    tm = sum(triple)/2
                    f@exprs = f@exprs[-sample(which(ap & bp & cp),tm),]
                }
                else if (ds=="pos36") { #1.5x A+B+ D+
                    tm = sum(double)
                    f@exprs = f@exprs[-unique(append(sample(which(dp),tm),
                                                     sample(which(ap & bp),tm/2))),]
                }

                # if (i == nsample*nctrl+1 & grepl("pos",ds)) {
                #
                #   ft = flowType(Frame=f, PropMarkers=ci, MarkerNames=markers,
                #                 MaxMarkersPerPop=min(markern,maxmarker), PartitionsPerMarker=2,
                #                 Thresholds=thress,
                #                 Methods='Thresholds', verbose=FALSE, MemLimit=60)
                #   ftcell = unlist(lapply(ft@PhenoCodes, function(x)
                #     decodePhenotype(x, ft@MarkerNames, rep(2,length(ft@MarkerNames))) ))
                #   ftv = ftv_ = ft@CellFreqs
                #   ftv = round(ftv/ftv[1],3)
                #   names(ftv) = ftcell
                #   a = getPhenCP(cp=ftcell,no_cores=no_cores)
                # }
            }
            fe = f@exprs
            colnames(fe) = LETTERS[1:ncol(fe)]
            # if (i%in%c(1:5,251:255,501:505,751:755) & grepl("pos",ds))
                save(fe,file=paste0(fcs_dir,"/a",i,".Rdata"))
            if (ds%in%c("pos30")) {
                thress = thress5
                ppm = rep(2,markern)
                ppm[1] = 3
                ppm[2] = 4
                ft = flowType(Frame=f, PropMarkers=ci, MarkerNames=markers,
                              MaxMarkersPerPop=min(markern,maxmarker), PartitionsPerMarker=ppm,
                              Thresholds=thress,
                              Methods='Thresholds', verbose=FALSE, MemLimit=60)
                ftcell = unlist(map(ft@PhenoCodes, function(x)
                    decodePhenotype(x, ft@MarkerNames, ppm) ))
                # ft = ft@CellFreqs
                names(ft@CellFreqs) = ftcell
            } else {
                thress = thress[colnames(f@exprs)]
                ft = flowType(Frame=f, PropMarkers=ci, MarkerNames=colnames(f@exprs),
                              MaxMarkersPerPop=min(markern,maxmarker), PartitionsPerMarker=2,
                              Thresholds=thress,
                              Methods='Thresholds', verbose=FALSE, MemLimit=60)#@CellFreqs
            }
            return(ft)
        })
    })
    ftl = unlist(ftl,recursive=FALSE)
    
    if (ds=="pos30") {
        fg0 = flowGraph(ftl, no_cores=no_cores, meta=meta_file, cumsum=TRUE,
                       calculate_summary=FALSE)
        # fg1 = fg_feat_cumsum(fg0, no_cores=no_cores)
        # 
        # fg0 = fg_feat_node_prop(fg0)
        # fg0 = fg_feat_edge_prop(fg0, no_cores=no_cores)
        # fg0 = fg_feat_node_norm(fg0, norm_path=paste0(result_dir,"/count_norm"), no_cores=no_cores)
        # fg0 = fg_feat_node_specenr(fg0, no_cores=no_cores)
        save(fg0, file=paste0(result_dir,"/fg.Rdata"))
        
        # fg1 = fg_feat_node_prop(fg1)
        # fg1 = fg_feat_edge_prop(fg1, no_cores=no_cores)
        # fg1 = fg_feat_node_norm(fg1, norm_path=paste0(result_dir,"_cumsum/count_norm"), no_cores=no_cores)
        # fg1 = fg_feat_node_specenr(fg1, no_cores=no_cores)
        # save(fg1, file=paste0(result_dir,"_cumsum/fg.Rdata"))
        
    } else {
        fg = flowGraph(ftl, no_cores=no_cores, meta=meta_file,
                       calculate_summary=FALSE)
                       # path=paste0(result_dir,"/fg"), label1="control")
        save(fg, file=paste0(result_dir,"/fg.Rdata"))
    }
    
    time_output(start2, ds)
    cat("\n")
    rm(list=c("ftl","fg")); gc()
}

result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
result_dirs <- result_dirs[grepl("pos",result_dirs)]
for (result_dir in result_dirs) {
    start1 = Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    fg <- fg_feat_node_specenr(fg, feature="count")

    save(fg, file=paste0(result_dir,"/fg.Rdata"))
flowGraph:::time_output(start1)
}

time_output(start)

```


# calculate edge feature specenr

```{r}

start1 = Sys.time()
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs) {
    start1 = Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
        
    if (!"expect_prop"%in%names(fg@feat$edge)) 
        fg <- fg_feat_edge_specenr(fg)
    
    save(fg, file=paste0(result_dir,"/fg.Rdata"))
flowGraph:::time_output(start1)
}

```

# Calculate summary statistics

```{r p_values, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
## cores
no_cores =  1

result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs) {try({
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    fg <- fg_clear_summary(fg)
    fg@etc$actualVSexpect <- NULL
    # if (grepl("pos|flowcap",result_dir)) next
    # if ("pchild"%in%names(fg@edge_list)) 
    #     names(fg@edge_list)[names(fg@edge_list)=="pchild"] <- "child"
    # if ("pparen"%in%names(fg@edge_list)) 
    #     names(fg@edge_list)[names(fg@edge_list)=="pparen"] <- "parent"

    # fnames <- names(fg@feat$node)[grep("MEAN",names(fg@feat$node))]
    # if (length(fnames)>0)
    #     for (fname in fnames)
    #         fg <- fg_rm_feature(fg, feature=fname)

    # fg <- fg_rm_feature(fg, type="edge", feature="prop")
    
    # no_cores <- ifelse (grepl("pregnancy|epic|genentech", result_dir), 15, 1)
    
    # fg <- fg_feat_node_norm(fg, no_cores=1, norm_path=paste0(result_dir,"/norm"))
    # fg <- fg_feat_node_specenr(fg, feature="count_norm")
    
    if (grepl("pregnancy|bodenmiller", result_dir)) {
        qt <- function(x,y)
            tryCatch(stats::t.test(x,y, paired=TRUE)$p.value,
                     error=function(e) 1)
        qw <- function(x,y) tryCatch(stats::wilcox.test(x,y, paired=TRUE)$p.value,
                                     error=function(e) 1)
        # fg = fg_summary(fg, no_cores=no_cores, class="class", label1="control",
        #                 overwrite=FALSE, 
        #                 test_name="wilcox_diminish", 
        #                 test_custom=qw,
        #                 node_features=c("prop","SpecEnr"), edge_features="NONE")
        fg = fg_summary(fg, no_cores=no_cores, class="class", label1="control",
                        overwrite=FALSE, 
                        test_name="t_diminish", 
                        test_custom=qt,
                        node_features=c("prop","SpecEnr"), edge_features="SpecEnr")
    } 
    else if (grepl("epic",result_dir)) {
        st <- function(x) tryCatch(stats::shapiro.test(x)$p.value, 
                                   error=function(e) 0)
        test_custom <- function(x,y) {
            if (st(x)>0.05 & st(y)>0.05)
                return(tryCatch(stats::t.test(x,y)$p.value, error=function(e) 1))
            return(tryCatch(stats::wilcox.test(x,y)$p.value, error=function(e) 1))
        }
        fg <- fg_summary(fg, no_cores=no_cores, test_name="wilt_diminish",
                         test_custom=test_custom, 
                         label1="control",
                         node_features=c("cells_ul_blood",
                                         "SpecEnr_cells_ul_blood"),
                         edge_features="SpecEnr",
                         overwrite=FALSE)
    } 
    else {
        # fg = fg_summary(fg, no_cores=no_cores, class="class", label1="control",
        #                 overwrite=FALSE, 
        #                 test_name="wilcox_diminish", 
        #                 node_features=c("prop","SpecEnr"), edge_features="NONE")
        fg = fg_summary(
            fg, no_cores=no_cores, class="class", label1="control",
            overwrite=FALSE, test_custom="t", test_name="t_diminish", 
            node_features=c("prop","SpecEnr"), edge_features="SpecEnr")
        if ("SpecEnr_count"%in%names(fg@feat$node)) 
            fg = fg_summary(
            fg, no_cores=no_cores, class="class", label1="control",
            overwrite=FALSE, test_custom="t", test_name="t_diminish", 
            node_features=c("SpecEnr_count"), edge_features="NONE")
        if ("pos"%in%result_dir) 
            fg = fg_summary(
            fg, no_cores=no_cores, class="class", label1="control",
            overwrite=FALSE, test_custom="t", test_name="t_diminish", 
            node_features=c("count"), edge_features="NONE")

        
    }
    
    # if (ncol(fg@summary_desc$node)==4) {
    #     dt <- fg@summary_desc$node
    #     dtcl <- str_split(dt$class_labels,"_")
    #     dt$label1 <- unlist(sapply(dtcl, tail, 1))
    #     dt$label2 <- unlist(sapply(dtcl, head, 1))
    #     dt$class_labels <- NULL
    #     fg@summary_desc$node <- dt
    # }
    
    
    for (i in seq_len(length(fg@summary$node)))
        fg@summary$node[[i]] <- list(values=fg@summary$node[[i]]$values)
    for (i in seq_len(length(fg@summary$edge)))
        fg@summary$edge[[i]] <- list(values=fg@summary$edge[[i]]$values)

    save(fg, file=paste0(result_dir,"/fg.Rdata"))
    rm(fg); gc()
})}

# # legacy: remove functions
# result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
# for (result_dir in result_dirs) { try({
#     cat(result_dir,"\n")
#     fg = get(load(paste0(result_dir,"/fg.Rdata")))
#     for (i in seq_len(length(fg@summary$node)))
#         fg@summary$node[[i]] <- list(values=fg@summary$node[[i]]$values)
#     for (i in seq_len(length(fg@summary$edge)))
#         fg@summary$edge[[i]] <- list(values=fg@summary$edge[[i]]$values)
# 
#     save(fg, file=paste0(result_dir,"/fg.Rdata"))
# }) }


# # legacy: calculate edge proportion
# for (result_dir in result_dirs) {try({
#     start <- Sys.time()
#     cat(result_dir,"\n")
#     fg = get(load(paste0(result_dir,"/fg.Rdata")))
#     
#     if (! length(fg@feat$edge))
#         fg <- fg_feat_edge_prop(fg, no_cores=1)
#     
#     save(fg, file=paste0(result_dir,"/fg.Rdata"))
#     flowGraph:::time_output(start)
# })}

# legacy: calculate efect sizes and adjust0
for (result_dir in result_dirs) {try({
    start <- Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    # fg@etc$effect_size <- NULL
    
    # indices <- sort(union(grep("MEAN",fg@summary_desc$node$feat),
    #                  grep("test0|adjust",fg@summary_desc$node$test_name)),
    #                 decreasing=TRUE)
    # if (length(indices)>0)
    #     for (index in indices)
    #         fg <- fg_rm_summary(fg, index=index)
    # fnames <- names(fg@feat$node)[grep("MEAN",names(fg@feat$node))]
    # if (length(fnames)>0)
    #     for (fname in fnames)
    #         fg <- fg_rm_feature(fg, feature=fname)

    for (i in seq_len(length(fg@summary$node)))
        pp <- fg_get_summary(fg, index=i)
    save(fg, file=paste0(result_dir,"/fg.Rdata"))
    print(fg@summary_desc$node)
    flowGraph:::time_output(start)
})}

# # legacy: add label to edge data frame
# for (result_dir in result_dirs) {
#     start <- Sys.time()
#     cat(result_dir,"\n")
#     fg = get(load(paste0(result_dir,"/fg.Rdata")))
#     
#     temp_se <- function(x)
#         stringr::str_extract_all(x, "[a-zA-Z0-9]+[+-]+")
#     from_ <- temp_se(fg@graph$e$from)
#     to_ <- temp_se(fg@graph$e$to)
#     fg@graph$e$marker <- purrr::map_chr(seq_len(length(from_)), function(x)
#         setdiff(to_[[x]], from_[[x]]))
#     
#     save(fg, file=paste0(result_dir,"/fg.Rdata"))
#     flowGraph:::time_output(start)
# }

# legacy: remove id's from summaries
for (result_dir in result_dirs) {
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    for (i in seq_len(length(fg@summary$node)))
        fg@summary$node[[i]] <- list(values=fg@summary$node[[i]]$values)
    save(fg, file=paste0(result_dir,"/fg.Rdata"))
}
```


# Distance matrices comparison between features (experimental)
```{r}
# see if different features create good distance matrices
no_cores = detectCores()-1
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs) { 
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    if (grepl("pregnancy|bodenmiller", result_dir)) {
        # distance plots, not yet added so will do separately
        a = flowGraph:::fg_plot_dist(fg, node_features=c("prop_MEAN_subject", "SpecEnr_MEAN_subject"),
                         edge_features="NONE",
                         class="class",
                         dist_method="euclidean", get_means=NULL,
                         plot_path=paste0(result_dir,"/fg/plots/distance.png"))
        
    } 
    else if (grepl("epic", result_dir)) {
        a = flowGraph:::fg_plot_dist(fg, node_features=c("cells_ul_blood", "SpecEnr_cells_ul_blood"),
                         edge_features="NONE",
                         class="class",
                         dist_method="euclidean", get_means=NULL,
                         plot_path=paste0(result_dir,"/fg/plots/distance.png"))
    }
    else {
        a = flowGraph:::fg_plot_dist(fg, node_features=c("count","prop", "SpecEnr"),
                         edge_features="NONE",
                         class="class",
                         dist_method="euclidean", get_means=NULL,
                         plot_path=paste0(result_dir,"/fg/plots/distance.png")) 
    }
}

```


## testing specenr_count
```{r}
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs) {try({
    cat(result_dir,"\n")
    start1 <- Sys.time()
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    
    m1p=colMeans(as.matrix(fg@feat$node$prop[1:10,]))
    m2p=colMeans(as.matrix(fg@feat$node$prop[11:20,]))
    m1e=colMeans(as.matrix(fg@feat$node$expect_prop[1:10,]))
    m2e=colMeans(as.matrix(fg@feat$node$expect_prop[11:20,]))
    m1s=colMeans(as.matrix(fg@feat$node$SpecEnr[1:10,]))
    m2s=colMeans(as.matrix(fg@feat$node$SpecEnr[11:20,]))
    m1c=colMeans(as.matrix(fg@feat$node$count[1:10,]))
    m2c=colMeans(as.matrix(fg@feat$node$count[11:20,]))
    m1sc=colMeans(as.matrix(fg@feat$node$SpecEnr_count[1:10,]))
    m2sc=colMeans(as.matrix(fg@feat$node$SpecEnr_count[11:20,]))
    m1ec=colMeans(as.matrix(fg@feat$node$expect_count[1:10,]))
    m2ec=colMeans(as.matrix(fg@feat$node$expect_count[11:20,]))

    dta <- data.frame(m1p,m1e,m1c,m1s,m1sc,m1ec,
                      m2p,m2e,m2c,m2s,m2sc,m2ec)
    
    flowGraph::time_output(start1)
})}
```


# Plots

```{r}
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
p_thres <- .05
for (result_dir in result_dirs) { try({
    # if (grepl("pos|flowcap",result_dir)) next
    start1 <- Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    # if (grepl("pregnancy|bodenmiller", result_dir)) {
    #     fg_save_plots(fg, paste0(result_dir,"/fg/plots"), box_no=0, 
    #                   adjust_custom=adjust_custom, paired=TRUE)
    # } else {
    #     fg_save_plots(fg, paste0(result_dir,"/fg/plots"), box_no=0,
    #                   adjust_custom=adjust_custom)
    # }
    
    # pparen <- fg@edge_list$parent
    # pchild <- fg@edge_list$child
    # start_phen <- fg@graph$v$phenotype[fg@graph$v$phenolayer==1]
    
    
    # + logged qq plots + interactive pVSdiff plot
    type <- "node"
    for (index in seq_len(length(fg@summary[[type]]))) {
        for (adjust_custom in c("BH","byLayer")) {
            # if (grepl("epic",result_dir) & index%in%c(2,4,10)) p_thres <- .1
            sm <- unlist(fg@summary_desc[[type]][index,])
            if (!grep("SpecEnr",unlist(sm))) next
            sm[2] <- paste0(sm[2], "_", ifelse(
                is.function(adjust_custom),"adjusted",adjust_custom))
            plot_path_ <- paste0(result_dir,"/fg/plots/", type, "/",
                                 paste0(unlist(sm), collapse="_"))
            dir.create(plot_path_, recursive=TRUE, showWarnings=FALSE)
            
            # fg_plot_pVSdiff(fg, index=index, interactive=TRUE,
            #                 path=paste0(plot_path_,"/pVSdifference.html"))
            
            pp1 <- fg_get_summary(
                fg, index=index,adjust_custom=adjust_custom,
                # filter_adjust0=.4, 
                filter_btwn_tpthres=.05, filter_btwn_es=.5)
            pp1sig <- pp1$values<.05
            sort(pp1$values[pp1sig])
            sum(pp1sig)
            
            fg_plot_qq(
                fg, type="node", index=index, logged=TRUE,
                adjust_custom=adjust_custom,
                path=paste0(plot_path_,"/qq_logged.png"))
            fg_plot_qq(
                fg, type="node", index=index, logged=F,
                adjust_custom=adjust_custom,
                path=paste0(plot_path_,"/qq.png"))
            
            fg_plot_pVSdiff(
                fg, index=index, interactive=F,
                adjust_custom=adjust_custom,
                path=paste0(plot_path_,"/pVSdifference.png"))
            
            if (grepl("SpecEnr",sm["feat"])) {
                fg_plot_qq(
                    fg, type="node", index=index, logged=F,
                    adjust_custom=adjust_custom,
                    path=paste0(plot_path_,"/qq_filtered.png"), 
                    filter_adjust0=.4, filter_btwn_tpthres=.05, filter_btwn_es=.5)
                fg_plot_qq(
                    fg, type="node", index=index, logged=T,
                    adjust_custom=adjust_custom,
                    path=paste0(plot_path_,"/qq_logged_filtered.png"),
                    filter_adjust0=.4, filter_btwn_tpthres=.05, filter_btwn_es=.5)
                
                fg_plot_pVSdiff(
                    fg, index=index, interactive=F,
                    adjust_custom=adjust_custom,
                    path=paste0(plot_path_,"/pVSdifference_filtered.png"),
                    filter_adjust0=.4, filter_btwn_tpthres=.05, filter_btwn_es=.5)
            }
            
            
            # cell hierarchy plots without number labels
            try ({
                ## cell hierarchy plot
                # p <- fg_get_summary(fg, type=type, index=index)$values
                gr <- fg_plot(
                    fg, type=type, p_thres=.05, index=index,
                    show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                    path=paste0(plot_path_,"/cell_hierarchy"),
                    interactive=FALSE,
                    adjust_custom=adjust_custom,
                    node_labels="NONE")
                
                if (is.null(gr)) next
                
                if (grepl("SpecEnr",sm["feat"])) {
                    feats <- flowGraph:::se_feats(sm["feat"])
                    
                    m1 <- fg_get_feature_means(fg, type, feats[2], id=pp1$id1)
                    m2 <- fg_get_feature_means(fg, type, feats[2], id=pp1$id2)
                    
                    gr_ <- gr <- fg_plot(
                        fg, type=type, p_thres=.05, index=index,
                        show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                        # mod_layout=TRUE,
                        # path=paste0(plot_path_,"/cell_hierarchy_filtered"), 
                        interactive=FALSE,
                        node_labels="NONE",
                        # filter_adjust0=.4, 
                        adjust_custom=adjust_custom, 
                        filter_btwn_tpthres=.05, filter_btwn_es=.5)
                    
                    col_o <- gr$v$colour
                    col_p <- m2-m1
                    col_p_ <- log(m2/m1)

                    gr_$v <- gr_$v[gr$v$v_ind,]
                    gr_$e <- gr$e[gr$e$from%in%gr_$v$phenotype &
                                      gr$e$to%in%gr_$v$phenotype,]
                    gr_$v[,c("x","y")] <- 
                        space_hierarchy(gr_$v[,c("y","x")])[,c(2,1)]
                    
                    mfrom <- match(gr_$e$from,gr_$v$phenotype)
                    mto <- match(gr_$e$to,gr_$v$phenotype)
                    gr_$e$from.x <- gr_$v$x[mfrom]
                    gr_$e$from.y <- gr_$v$y[mfrom]
                    gr_$e$to.x <- gr_$v$x[mto]
                    gr_$e$to.y <- gr_$v$y[mto]

                    gp <- plot_gr(gr_)
                    ggplot2::ggsave(
                        paste0(plot_path_,"/cell_hierarchy_filtered.png"),
                        plot=gp, scale=1, width=9, height=9,
                        units="in", dpi=600, limitsize=TRUE)
                    
                    gr_$v$colour <- col_p[gr$v$v_ind]
                    gp <- plot_gr(gr_)
                    ggplot2::ggsave(
                        paste0(plot_path_,"/cell_hierarchy_filtered_prop.png"),
                        plot=gp, scale=1, width=9, height=9,
                        units="in", dpi=600, limitsize=TRUE)
                    
                                        gr_$v$colour <- col_p_[gr$v$v_ind]
                    gp <- plot_gr(gr_)
                    ggplot2::ggsave(
                        paste0(plot_path_,"/cell_hierarchy_filtered_propr.png"),
                        plot=gp, scale=1, width=9, height=9,
                        units="in", dpi=600, limitsize=TRUE)

                    gr_$v$colour <- ifelse(col_o[gr$v$v_ind]>0,1,-1)
                    gp <- plot_gr(gr_, colour_edges=TRUE)
                    ggplot2::ggsave(
                        paste0(plot_path_,"/cell_hierarchy_filtered_.png"),
                        plot=gp, scale=1, width=9, height=9,
                        units="in", dpi=600, limitsize=TRUE)
                    
                    gr_$v$colour <- ifelse(col_p[gr$v$v_ind]>0,1,-1)
                    gp <- plot_gr(gr_, colour_edges=TRUE)
                    ggplot2::ggsave(
                        paste0(plot_path_,"/cell_hierarchy_filtered_prop_.png"),
                        plot=gp, scale=1, width=9, height=9,
                        units="in", dpi=600, limitsize=TRUE)
                    

                    # gr <- fg_plot(
                    #     fg, type=type, p_thres=.05, index=index,
                    #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                    #     # path=paste0(plot_path_,"/cell_hierarchy_filtered"), 
                    #     interactive=TRUE,
                    #     node_labels="NONE",
                    #     # filter_adjust0=.4, 
                    #     adjust_custom=adjust_custom,
                    #     filter_btwn_tpthres=.05, filter_btwn_es=.5)
                    # visNetwork::visSave(
                    #     plot_gr(gr, interactive=TRUE),
                    #     file=paste0(plot_path_,"/cell_hierarchy_filtered.html"),
                    #     background="white")

                    
                    
                    if (adjust_custom=="BH") {
                        plot_path_box <- paste0(plot_path_,"/box")
                        dir.create(plot_path_box, showWarnings=FALSE,
                                   recursive=TRUE)
                        cpopis <- which(pp1sig)
                        cpopis <- cpopis[order(pp1$values[cpopis])]
                        for (cpopi in seq_len(length(cpopis))) {
                            cpop <- cpopis[cpopi]
                            bp <- flowGraph:::fg_plot_box_set(
                                fg, type="node", index=index, node_edge=cpop,
                                filter_es=.5, filter_adjust0=.5,
                                filter_btwn_es=.5, filter_btwn_tpthres=.05,
                                adjust_custom=adjust_custom,dotplot=F,
                                path=paste0(
                                    plot_path_box,"/",
                                    stringr::str_pad(cpopi,width=3,pad="0"), "_",
                                    names(pp1$values)[cpop], ".png"))
                        }
                    }
                }
                
                # gr_ <- gr <- fg_plot(
                #     fg, type="node", p_thres=p_thres, index=index,
                #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                #     label_max=15,
                #     node_labels="NONE")
                # if (is.null(gr)) next
                
                # sigs <- sigs_allpar <- sig_allchd <- list()
                # sig_allchd[[1]] <- sigs[[1]] <- sig_phen <- start_phen[p[start_phen]<p_thres]
                # sigs_allpar[[1]] <- rep(TRUE, length(sigs[[1]]))
                # while(TRUE) {
                #     p_layer <- length(sigs)+1
                #     chld <- unique(unlist(pchild[sig_phen]))
                #     if (length(chld)==0) break
                #     # p_parn <- p[sig_phen]
                #     p_chld <- p[chld]
                #     
                #     sig_child <- chld[p_chld<p_thres]
                #     if (length(sig_child)==0) break
                #     sigs[[p_layer]] <- sig_child
                #     
                #     sigs_allpar[[p_layer]] <- 
                #         purrr::map_lgl(sig_child, function(x)
                #             all(pparen[[x]]%in%sig_phen))
                #     
                #     sig_allchd[[p_layer]] <-
                #         unique(unlist(pparen[sig_child[sigs_allpar[[p_layer]]]]))
                #     
                #     sig_phen <- sig_child
                # }
                # sigs_ <- unlist(purrr::map(seq_len(length(sigs)), function(i)
                #     sigs[[i]][sigs_allpar[[i]]]))
                # sig_ind <- gr_$v$phenotype%in%sigs_
                # 
                # gr <- fg_plot(
                #     fg, type=type, p_thres=.01, index=index, show_nodes_edges=sig_ind,
                #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                #     path=paste0(plot_path_,"/cell_hierarchy_strict"), interactive=TRUE,
                #     node_labels=nlabels)
                # 
                # gr <- fg_plot(
                #     fg, type=type, p_thres=.01, index=index, 
                #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
                #     path=paste0(plot_path_,"/cell_hierarchy_strict"), interactive=TRUE,
                #     node_labels=nlabels)
                
                # # don't label if colour too light, ie too close to 0
                # l_ind <- which(gr$v$label_ind)
                # colmax <- max(abs(gr$v$colour))
                # l_ind_not <- l_ind[abs(gr$v$colour[l_ind]) < colmax*.3]
                # gr$v$label_ind[l_ind_not] <- FALSE
                # 
                # gr$v$label <- gr$v$phenotype
                # gp <- plot_gr(gr, show_bgedges=ifelse(grepl("pos",result_dir),TRUE, FALSE))
                # ggsave(plot=gp, filename=paste0(plot_path_,"/cell_hierarchy_.png"),
                #        width=8, height=7)
                
                # # plot only one group and their ancestors (cell pops with same markers)
                # pparen <- fg@edge_list$parent
                # v_ind <- which(gr$v$v_ind)
                # show_phen <- gr$v$phenotype[gr$v$v_ind]
                # show_phen_ <- gsub("[+-]","_",show_phen)
                # show_phen_u <- unique(show_phen_[duplicated(show_phen_)])
                # if (length(show_phen_u) < length(show_phen)) {
                #     path <- paste0(plot_path_,"/cell_hierarchy")
                #     dir.create(path, showWarnings=FALSE)
                #     for (phen in show_phen_u) {
                #         gr_ <- gr
                #         leaves <- v_ind[show_phen_==phen]
                #         v_ind_ <- rep(FALSE, nrow(gr$v))
                #         v_ind_[leaves] <- TRUE
                #         layer <- gr$v$phenolayer[leaves[1]]
                #         curr <- gr$v$phenotype[leaves]
                #         if (layer > 0)
                #             while (length(curr)>0) {
                #                 par_phen <- unlist(pparen[curr])
                #                 par_ind <- gr$v$phenotype%in%par_phen & gr$v$v_ind
                #                 v_ind_[par_ind] <- TRUE
                #                 curr <- gr$v$phenotype[par_ind]
                #             }
                #         gr_$v$v_ind <- gr_$v$label_ind <- v_ind_
                #         gr_$e$e_ind <- gr$e$from%in%gr$v$phenotype[v_ind_] &
                #             gr$e$to%in%gr$v$phenotype[v_ind_]
                #         gr_$v <- gr_$v[gr_$v$v_ind,]
                #         gr_$e <- gr_$e[gr_$e$from%in%gr$v$phenotype &
                #                            gr_$e$to%in%gr$v$phenotype,]
                #         
                #         gr_ <- set_layout_graph(gr_)
                #         # gp <- plot_gr(gr_)
                #         gp <- plot_gr(gr__, label_coloured=FALSE, interactive=TRUE)
                #         # ggsave(paste0(path,"/",phen,"_",sum(v_ind_),".png"),
                #         #        plot=gp, scale=1, width=9, height=9,
                #         #        units="in", dpi=500, limitsize=TRUE)
                #         htmlwidgets::saveWidget(
                #             gp, file=paste0(path,"/",phen,sum(v_ind_),".html"))
                #         
                #     }
                # }
                # 
                # if (sum(p<.01)>30)s
                #     gr <- fg_plot(fg, type="node", p_thres=sort(p)[25],
                #                   index=index, label_max=20,
                #                   show_bgedges=TRUE, path=paste0(plot_path_,"/cell_hierarchy_top25"))
            })
            # if (grepl("epic",result_dir) & index%in%c(2,4,10)) p_thres <- .01
        }
    }
    
    flowGraph:::time_output(start1)
})}

```


## plots for pub
```{r}
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
result_dirs <- result_dirs[grepl("pos11|pos15|pos26|pos31|pos35|pos36|flowcap_6$|pregnancy",result_dirs)]
p_thres <- .05
type <- "node"
adjust_custom <- "byLayer"
wh <- c(8,6)
for (result_dir in result_dirs) { try({
    start1 <- Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    
    indices <- 1:nrow(fg@summary_desc$node)
    for (index in indices) {
        # if (grepl("epic",result_dir) & index%in%c(2,4,10)) p_thres <- .1
        sm <- unlist(fg@summary_desc[[type]][index,])
        sm[2] <- paste0(sm[2], "_", ifelse(
            is.function(adjust_custom),"adjusted",adjust_custom))
        plot_path_ <- paste0(result_dir,"/fg/plots/", type, "/",
                             paste0(unlist(sm), collapse="_"))
        dir.create(plot_path_, recursive=TRUE, showWarnings=FALSE)
        
        # fg_plot_pVSdiff(fg, index=index, interactive=TRUE,
        #                 path=paste0(plot_path_,"/pVSdifference.html"))
        
        pp1 <- fg_get_summary(
            fg, index=index,adjust_custom=adjust_custom,
            # filter_adjust0=.4, 
            filter_btwn_tpthres=.05, filter_btwn_es=.5)
        pp1sig <- pp1$values<.05
        sort(pp1$values[pp1sig])
        sum(pp1sig)
        
        gr <- fg_plot(
            fg, type=type, p_thres=.05, index=index,
            show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
            # path=paste0(plot_path_,"/cell_hierarchy"),
            interactive=FALSE, 
            adjust_custom=adjust_custom,
            filter_btwn_tpthres=.05, filter_btwn_es=.5,
            node_labels="NONE")
        gr$v$label <- gr$v$phenotype
        
        gr$v$label_ind <- FALSE
        if (grepl("pos[13]1",result_dir))
            truepos <- c("A+","A-")
        if (grepl("pos[13]5",result_dir))
            truepos <- c("A+B+C+","A+B+","A+C+","B+C+","A+","B+","C+")
        if (grepl("pos[23]6",result_dir))
            truepos <- c("A+","B+","D+","A+B+","A+B+D+")
        if (grepl("flowcap",result_dir))
            truepos <- c("FS-","SS-","HLA+","CD38+",
                         "FS-CD34+","SS-CD34+",
                         "HLA+CD117-CD45+CD34+",
                         "FS-SS+CD45-","FS-SS+CD117+CD45-")
        if (grepl("pregnancy",result_dir))
            truepos <- c("CD3+","CD45RA+","CD16+",
                         "CD3+CD45RA+CD56-Tbet-",
                         "CD3+CD45RA+CD56-CD8-Tbet-TCRgd-",
                         "CD3+CD45RA+CD56-CD7+CD8-Tbet-",
                         "CD3+CD45+CD45RA+CD56-CD8-Tbet-",
                         "CD3+CD45RA+CD45-CD8-Tbet-",
                         "CD7+CD8+","CD7+CD8+Tbet+",
                         "CD16+CD56-CD7-TCRgd-"
                         )
        gr$v$label_ind[gr$v$phenotype%in%truepos] <- TRUE
        gr_ <- gr
        
        col_o <- gr$v$colour
        # gr_$colour <- col_o
        gp <- plot_gr(gr_, label_coloured=FALSE)
        ggplot2::ggsave(
            paste0(plot_path_,"/cell_hierarchy_filtered_PUB.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)

        gr_size <- gr_$v$size
        gr_$v$size <- 1
        gr_$colour <- col_o
        gp <- plot_gr(gr_, label_coloured=FALSE)
        ggplot2::ggsave(
            paste0(plot_path_,"/cell_hierarchy_filtered_PUB_.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)
        gr_$v$size <- gr_size

        gr_$v$colour <- ifelse(col_o>0,1,-1)
        gp <- plot_gr(gr_, colour_edges=TRUE)
        ggplot2::ggsave(
            paste0(plot_path_,"/cell_hierarchy_filtered_.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)

        if (grepl("SpecEnr",sm["feat"])) {
            feats <- flowGraph:::se_feats(sm["feat"])
            
            m1 <- fg_get_feature_means(fg, type, feats[2], id=pp1$id1)
            m2 <- fg_get_feature_means(fg, type, feats[2], id=pp1$id2)

            gr_$v$v_ind[(m2>m1 & gr$v$colour<0) | (m2<m1 & gr$v$colour>0)] <- F

            col_p <- m2-m1
            
            m1m2 <- cbind(gr$v$phenotype,pp1$values,col_o,col_p)
            colnames(m1m2) <- c("phenotype",paste0("p_",adjust_custom),
                                "SpecEnr_diff","prop_diff")
            m1m2_ <- m1m2 <- m1m2[pp1sig,]
            write.csv(m1m2,file=paste0(plot_path_,".csv"), row.names=FALSE)
            m1m2_ <- m1m2_[(m1m2_[,3]>0 & m1m2_[,4]>0) | 
                               (m1m2_[,3]<0 & m1m2_[,4]<0),]
            write.csv(m1m2_,file=paste0(plot_path_,"_.csv"), row.names=FALSE)
            
            # gr_$v <- gr_$v[gr$v$v_ind,]
            # gr_$e <- gr$e[gr$e$from%in%gr_$v$phenotype &
            #                   gr$e$to%in%gr_$v$phenotype,]
            # gr_$v[,c("x","y")] <-
            #     space_hierarchy(gr_$v[,c("y","x")])[,c(2,1)]
            # mfrom <- match(gr_$e$from,gr_$v$phenotype)
            # mto <- match(gr_$e$to,gr_$v$phenotype)
            # gr_$e$from.x <- gr_$v$x[mfrom]
            # gr_$e$from.y <- gr_$v$y[mfrom]
            # gr_$e$to.x <- gr_$v$x[mto]
            # gr_$e$to.y <- gr_$v$y[mto]

            gr_$v$colour <- col_p#[gr$v$v_ind]
            gp <- plot_gr(gr_, label_coloured=FALSE)
            ggplot2::ggsave(
                paste0(plot_path_,"/cell_hierarchy_filtered_prop_PUB.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)
            
            gr_size <- gr_$v$size
            gr_$v$size <- 1
            gr_$v$colour <- col_p#[gr$v$v_ind]
            gp <- plot_gr(gr_, label_coloured=FALSE)
            ggplot2::ggsave(
                paste0(plot_path_,"/cell_hierarchy_filtered_prop_PUB_.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)
            gr_$v$size <- gr_size

            gr_$v$colour <- ifelse(col_p>0,1,-1)
            gp <- plot_gr(gr_, colour_edges=TRUE)
            ggplot2::ggsave(
                paste0(plot_path_,"/cell_hierarchy_filtered_prop__.png"),
                plot=gp, scale=1, width=wh[1], height=wh[2],
            units="in", limitsize=TRUE)#, dpi=600)
            
        }


        
        flowGraph:::time_output(start1)
    }
})}

```



### trying stuff out

```{r}
p_thres <- .05

result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs[c(1,13:53)]) { try({
    start1 <- Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    

    index # specenr
    type <- "node"
    
    pp <- fg_get_summary(fg, index=index)
    p <- pp$values
    sigs <- sigs_allpar <- list()
    sigs[[1]] <- sig_phen <- start_phen[p[start_phen]<p_thres]
    sigs_allpar[[1]] <- rep(TRUE, length(sigs[[1]]))
    while(TRUE) {
        chld <- unique(unlist(pchild[sig_phen]))
        if (length(chld)==0) break
        # p_parn <- p[sig_phen]
        p_chld <- p[chld]
        
        sig_child <- chld[p_chld<p_thres]
        if (length(sig_child)==0) break
        sigs[[length(sigs)+1]] <- sig_child
        
        sigs_allpar[[length(sigs_allpar)+1]] <- purrr::map_lgl(sig_child, function(x)
            all(pparen[[x]]%in%sig_phen))
        sig_phen <- sig_child
    }
    sigs_ <- unlist(purrr::map(seq_len(length(sigs)), function(i)
        sigs[[i]][sigs_allpar[[i]]]))

            
    flowGraph:::time_output(start1)
})}

```

### Rchy plots (experimental)
```{r}
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
# result_dirs = result_dirs[grepl("pos",result_dirs)]
for (result_dir in result_dirs) {
    # if (!grepl("genentech",result_dir)) next
    print(result_dir)
    try ({
        # load flowGraph
        fg = get(load(paste0(result_dir,"/fg.Rdata")))
        
        for (index in seq_len(length(fg@summary$node))) {
            pdf(paste0(result_dir,"/plots/node_",
                       paste0(unlist(fg@summary_desc$node[index,]),collapse="_"),"/rchy.pdf"))
            fg_plot_rchy(fg, index=index, phen_start=fg@graph$v$phenotype[fg@graph$v$phenolayer==4], pathCount=5)
            dev.off()
        }
    })
}


```




### qq plot (pos15; temp)

```{r plot_test_qq, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
# phen = fg@graph$v$phenotype
# phen_ = gsub("A[-+]|B[-+]|C[-+]", "", phen)
# sig_inds = phen_==""
# qvals = fg_get_summary(fg, type="node", summary_meta=list(
#     feature="SpecEnr", test_name="t_byLayer",
#     class="class", cls_labels="control_exp"))$values
# 
# # plot for all q values
# plotly::plot_ly(x=~c(1:length(qvals)), y=~sort(qvals), mode="markers",
#                 text=paste0(names(qvals)[order(qvals)], ": ", sort(qvals)),
#                 hoverinfo="text")
# 
# # plot removed 0's
# no0 = qvals!=0
# p = plotly::plot_ly(x=~c(1:sum(no0)), y=~sort(qvals[no0]), mode="markers",
#                 text=paste0(names(qvals[no0])[order(qvals[no0])], ": ", sort(qvals[no0])),
#                 hoverinfo="text") %>%
# plotly::layout(title="qq plot for pos15 (A+B+C+); no sig nodes included; T-test")
# # htmlwidgets::saveWidget(plotly::as_widget(p), paste0(result_dir, "/plots/2019-12-30_pos15_ABC_t_byLayer_qq_no-ABC.html"))
# 
# # plot removed 0's logged
# qvalsl = log(qvals)
# p = plotly::plot_ly(x=~c(1:sum(no0)), y=~sort(qvalsl[no0]), mode="markers",
#                 text=paste0(names(qvalsl[no0])[order(qvalsl[no0])], ": ", sort(qvalsl[no0])),
#                 hoverinfo="text") %>%
# plotly::layout(title="qq plot for pos15 (A+B+C+) LOGGED; no sig nodes included; T-test")
# # htmlwidgets::saveWidget(plotly::as_widget(p), paste0(result_dir, "/plots/2019-12-30_pos15_ABC_t_byLayer_qqlog_no-ABC.html"))
# 
# time_output(start1)

```





### plots looking at edge p-value difference between child-parent
```{r}
# calculate difference between actual and expected first



interactive <- FALSE
p_t1 <- p_t2 <- .05
cd_t1 <- .5 # cohen's d: |d|<0.2 "negligible", |d|<0.5 "small", |d|<0.8 "medium", otherwise "large"
filter_es <- 0
filter_adjust0 <- 1
med_count_thres <- 50
type="node"
adjust_custom="BH"
absolute <- FALSE
logged <- TRUE


start1 = Sys.time()
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
# make edge condiitons first
for (result_dir in result_dirs) {
    start1 = Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    fg@etc$actualVSexpect <- list()
    fg@etc$actualVSexpect$node <- fg@etc$actualVSexpect$edge <- list()

    # features to compare
    compare_feats_ <- compare_feats <- c("SpecEnr", "prop")
    if (grepl("epichipc",result_dir))
        compare_feats <- c("SpecEnr_cells_ul_blood", "cells_ul_blood")
    se_inds <- which(fg@summary_desc$node$feat==compare_feats[1] &
                         grepl("t_",fg@summary_desc$node$test_name))
    
    for (se_ind in se_inds) {
        sm_name <- paste0(unlist(fg@summary_desc$node[se_ind,-2]), collapse="_")
        sm_name_ <- append("SpecEnr",fg@summary_desc$node[se_ind,c(3:5)])
        pp <- fg_get_summary(fg, index=se_ind)
        features <- flowGraph:::se_feats(compare_feats[1])
        features_ <- c("SpecEnr","prop","expect_prop")
        
        # fg@etc$actualVSexpect[["node"]][[sm_name]] <- flowGraph:::fg_btwn_(
        #     id1=pp$id1, id2=pp$id2, 
        #     mp=as.matrix(fg@feat$node[[features[2]]]),
        #     mep=as.matrix(fg@feat$node[[features[3]]]),
        #     btwn_test_custom=function(x,y)
        #         tryCatch(stats::t.test(x,y)$p.value, error=function(e) 1))
        fg@etc$actualVSexpect[["edge"]][[paste0(unlist(sm_name_), collapse="_")]] <- flowGraph:::fg_btwn_(
            id1=pp$id1, id2=pp$id2, 
            mp=as.matrix(fg@feat$node[[features_[2]]]),
            mep=as.matrix(fg@feat$node[[features_[3]]]),
            btwn_test_custom=function(x,y)
                tryCatch(stats::t.test(x,y)$p.value, error=function(e) 1))

    }
    
    save(fg, file=paste0(result_dir,"/fg.Rdata"))
    flowGraph:::time_output(start1)
}

for (result_dir in result_dirs) {
    start1 = Sys.time()
    cat(result_dir,"\n")
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    
    # features to compare
    compare_feats <- c("SpecEnr", "prop")
    if (grepl("epichipc",result_dir))
        compare_feats <- c("SpecEnr_cells_ul_blood", "cells_ul_blood")
    
    # which summary statistic inds involve SpecEnr feature
    se_inds <- which(fg@summary_desc$node$feat==compare_feats[1] &
                         grepl("t_",fg@summary_desc$node$test_name))
    if (length(se_inds)==0) next

    # indices to turn cell populations into edges from and to
    ifrom <- match(fg@graph$e$from, fg@graph$v$phenotype)
    ito <- match(fg@graph$e$to, fg@graph$v$phenotype)
    

    
    # boxplot(mp[pp1$id1,"HLA+CD117-CD45-"],mep[pp1$id1,"HLA+CD117-CD45-"])
    
    for (se_ind in se_inds) { try({
        summary_meta <- unlist(fg@summary_desc$node[se_ind,])
        sm_name <- paste0(summary_meta[-2], collapse="_")
        sm_name_ <- paste0("SpecEnr",paste0(summary_meta[-c(1:2)], collapse="_"))
        se_ind_ <- flowGraph:::fg_get_summary_index(
            fg, type="edge", summary_meta=append("SpecEnr",summary_meta[-1]))
        
        
        summary_meta <- fg@summary_desc$node[se_ind,]
        summary_meta["test_name"] <- paste0(unlist(summary_meta["test_name"]),
                                            "_",adjust_custom)
        plot_path_ <- paste0(result_dir,"/fg/plots/", type, "/",
                             paste0(unlist(summary_meta), collapse="_"))
        dir.create(plot_path_, recursive=TRUE, showWarnings=FALSE)
        
        ## expore
        df_ <- fg@etc$actualVSexpect$node$SpecEnr_class_control_aml
        # df_ <- fg@etc$actualVSexpect$node$SpecEnr_class_control_exp

        # cpop <- "FS-SS-HLA+CD117+CD45-CD34-CD38+"
        # df_[df_$phenotype==cpop,]
        # bp <- fg_plot_box_set(
        #     fg, index=se_ind, node_edge=cpop,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     adjust_custom=adjust_custom,
        #     dotplot=FALSE, outlier=FALSE)
        # plot(bp)
        
        
        
        
        pp0 <- fg_get_summary(
            fg, type="edge", summary_meta=unlist(append(
                "SpecEnr", fg@summary_desc$node[se_ind,-1])),
            filter_es=filter_es, filter_adjust0=filter_adjust0,
            filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
            adjust_custom=adjust_custom)
        pp0sig <- pp0$values<p_t1
        
        # split up so clearer
        pp1 <- fg_get_summary(
            fg, index=se_ind, filter_es=filter_es, filter_adjust0=filter_adjust0,
            filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
            adjust_custom=adjust_custom, default_p_thres=.05)
        pp1sig <- pp1$values<p_t1
        
        pp1_ <- fg_get_summary(fg, index=se_ind, adjust_custom=adjust_custom)
        pp1sig_ <- pp1_$values<p_t1
        
        filt_nonsig <- !pp1sig & pp1sig_
        
        # plot_path_box <- paste0(plot_path_,"/box")
        # dir.create(plot_path_box, showWarnings=FALSE, recursive=TRUE)
        # cpopis <- which(pp1sig)
        # cpopis <- cpopis[order(pp1$values[cpopis])]
        # for (cpopi in seq_len(length(cpopis))) {
        #     cpop <- cpopis[cpopi]
        #     bp <- flowGraph:::fg_plot_box_set(
        #         fg, type="node", index=se_ind, node_edge=cpop,
        #         filter_es=filter_es, filter_adjust0=filter_adjust0,
        #         filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #         adjust_custom=adjust_custom,dotplot=F,
        #         path=paste0(plot_path_box,"/",
        #                     stringr::str_pad(cpopi,width=3,pad="0"), "_",
        #                     names(pp1$values)[cpop], ".png"))
        #     bp <- flowGraph:::fg_plot_box_set(
        #         fg, type="node", index=se_ind, node_edge=cpop,
        #         filter_es=filter_es, filter_adjust0=filter_adjust0,
        #         filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #         adjust_custom=adjust_custom,dotplot=F, outlier=FALSE,
        #         path=paste0(plot_path_box,"/",
        #                     stringr::str_pad(cpopi,width=3,pad="0"), "_",
        #                     names(pp1$values)[cpop], "_.png"))
        # 
        # }
        
        # gr <- fg_plot(
        #     fg, type="node", index=se_ind,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
        #     path=paste0(plot_path_,"/cell_hierarchy_edge.html"), interactive=TRUE,
        #     node_labels="NONE",
        #     adjust_custom=adjust_custom)
        # gr$v$v_ind <- pp1sig
        #     gp <- plot_gr(gr, interactive=TRUE)
        #     visNetwork::visSave(
        #         gp, file=paste0(plot_path_,"/cell_hierarchy_edge.html"),
        #         background="white")
        # 
        # gr <- fg_plot(
        #     fg, type="node", index=se_ind,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE), label_max=5,
        #     path=paste0(plot_path_,"/cell_hierarchy_edge.png"), interactive=FALSE,
        #     node_labels=compare_feats,
        #     adjust_custom=adjust_custom)
        # fg_plot_pVSdiff(
        #     fg, type="node", index=se_ind,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     path=paste0(plot_path_,"/pVSdifference_edge.png"), interactive=FALSE,
        #     adjust_custom=adjust_custom)
        # fg_plot_qq(
        #     fg, type="node", index=se_ind,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     logged=TRUE,
        #     path=paste0(plot_path_,"/qq_logged_edge.png"), interactive=FALSE,
        #     adjust_custom=adjust_custom)
        # fg_plot_qq(
        #     fg, type="node", index=se_ind,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     logged=FALSE,
        #     path=paste0(plot_path_,"/qq_edge.png"), interactive=FALSE,
        #     adjust_custom=adjust_custom)
        # 
        # try({
        #     gr <- fg_plot(
        #         fg, type="edge", index=se_ind_, show_nodes_edges=pp0sig,
        #         show_bgedges=ifelse(grepl("pos",result_dir), TRUE, FALSE),
        #         label_max=5,
        #         path=paste0(plot_path_,"/cell_hierarchy_edge_.png"),
        #         interactive=FALSE, node_labels=compare_feats,
        #         adjust_custom=adjust_custom)
        # })
        
        # bp <- flowGraph:::fg_plot_box_set(
        #     fg, type="node", index=se_ind, node_edge=858,
        #     filter_es=filter_es, filter_adjust0=filter_adjust0,
        #     filter_btwn_es=cd_t1, filter_btwn_tpthres=p_t1,
        #     adjust_custom=adjust_custom)
        
        
        
        pp2 <- fg_get_summary(
            fg, summary_meta=unlist(
                append(compare_feats[2], fg@summary_desc$node[se_ind,-1])),
            adjust_custom=adjust_custom) # error if not found
        pp2sig <- pp2$values<p_t2
        
        # get counts
        mc_med1 <- apply(as.matrix(fg@feat$node$count[pp1$id1,]),2,median)
        mc_med2 <- apply(as.matrix(fg@feat$node$count[pp1$id2,]),2,median)
        mc_med <- ifelse(mc_med1>mc_med2, mc_med1, mc_med2)
        good_count <- mc_med > med_count_thres
        good_count_ <- good_count[ito] & good_count[ifrom]
        
        dfa <- fg@graph$v
        dfa$xp <- log(pp1$values,10)
        dfa$yp <- log(pp2$values,10)
        dfa$xcd <- pp1$cohensd
        dfa$ycd <- pp2$cohensd
        dfa$med_count <- mc_med
        dfa$sig <- "insig"
        dfa$sig[pp1sig & pp2sig] <- "sig"
        dfa$sig[pp1sig & !pp2sig] <- "sig_SpecEnr"
        dfa$sig[!pp1sig & pp2sig] <- "sig_raw"
        # dfa$sig <- as.factor(dfa$sig)
        dfa$label_long <- paste0(
            dfa$phenotype,"\n- SpecEnr: ", 
            signif(dfa$xcd,3), ", ", signif(dfa$xp,3),
            "\n- raw: ", signif(dfa$ycd,3), ", ", signif(dfa$yp,3))
        dfa$sig_label <- as.factor(paste0(
            ifelse(filt_nonsig,"filt.",""), 
            ifelse(pp1sig,"","in"), "sig/",
            ifelse(pp2sig,"","in"),"sig"))

        qp <- ggplot2::ggplot(dfa[good_count,], ggplot2::aes(
            x=xcd,y=ycd, colour=phenolayer,
            size=med_count)) +
            ggplot2::scale_shape_manual(values=1:nlevels(dfa$sig_label))+
            ggplot2::geom_abline(intercept=0, slope=1) +
            ggplot2::ggtitle(paste0(
                "(", sum(good_count),
                ") comparing cohen's d ",
                "-log10 ","p-values")) +
            ggplot2::labs(
                x="SpecEnr cohen's d",
                y="raw cohen's d",
                col="layer",
                size="count med") +
            ggplot2::scale_colour_gradientn(
                colours=c('blue','cyan','yellow','red'))
        
        if (interactive) {
            qp <- qp +
                ggiraph::geom_point_interactive(
                    ggplot2::aes(
                        tooltip=label_long, alpha=.1,stroke=1, shape=1))
            htmlwidgets::saveWidget(
                ggiraph::girafe(ggobj=qp),
                paste0(plot_path_,"/SpecEnrVSrawCOHENSD", 
                       ifelse(absolute,"_abs",""), 
                       ifelse(logged,"_log10",""),".html"))
        } else {
            qp <- qp +
                ggplot2::geom_point(
                    stroke=1, ggplot2::aes(shape=sig))
            ggplot2::ggsave(
                paste0(plot_path_,"/SpecEnrVSrawCOHENSD", 
                       ifelse(absolute,"_abs",""), 
                       ifelse(logged,"_log10",""),".png"), 
                plot=qp, scale=1, width=5, height=5,
                units="in", dpi=500, limitsize=TRUE)
        }
        
        qp <- ggplot2::ggplot(dfa[good_count,], ggplot2::aes(
            x=log(xp,10),y=log(yp,10), colour=phenolayer, size=med_count)) +
            ggplot2::scale_shape_manual(values=1:nlevels(dfa$sig_label))+
            ggplot2::geom_abline(intercept=0, slope=1) +
            ggplot2::ggtitle(paste0(
                "(", sum(good_count),
                ") comparing p-values ",
                "-log10 ","p-values")) +
            ggplot2::labs(
                x="SpecEnr p-value",
                y="raw p-value",
                col="layer",
                size="count med") +
            ggplot2::scale_colour_gradientn(
                colours=c('blue','cyan','yellow','red'))
        
        if (interactive) {
            qp <- qp +
                ggiraph::geom_point_interactive(
                    ggplot2::aes(
                        tooltip=label_long, alpha=.1,stroke=1, shape=sig_label))
            htmlwidgets::saveWidget(
                ggiraph::girafe(ggobj=qp),
                paste0(plot_path_,"/SpecEnrVSrawPVALUE", 
                       ifelse(absolute,"_abs",""), 
                       ifelse(logged,"_log10",""),".html"))
        } else {
            qp <- qp +
                ggplot2::geom_point(
                    stroke=1, ggplot2::aes(shape=sig_label))
            ggplot2::ggsave(
                paste0(plot_path_,"/SpecEnrVSrawPVALUE", 
                       ifelse(absolute,"_abs",""), 
                       ifelse(logged,"_log10",""),".png"), 
                plot=qp, scale=1, width=5, height=5,
                units="in", dpi=500, limitsize=TRUE)
        }
        
        
        
        
        #### EDDGE ####
        df <- data.frame(
            phenotype=paste0(fg@graph$e$from,"_",fg@graph$e$to),
            phenolayer=fg@graph$v$phenolayer[ito],
            eprop_change=abs(
                colMeans(as.matrix(fg@feat$edge$prop[pp1$id1,])) -
                    colMeans(as.matrix(fg@feat$edge$prop[pp1$id2,]))),
            mean_count=colMeans(as.matrix(fg@feat$node$count))[ito],
            med_count=mc_med[ito],
            xpfrom=pp1$values[ifrom],
            xpto=pp1$values[ito],
            ypfrom=pp2$values[ifrom],
            ypto=pp2$values[ito],
            xpfrom_=pp1_$values[ifrom],
            xpto_=pp1_$values[ito]
        )
        df$label_long <- paste0(
            df$phenotype,"\n- SpecEnr: ", df$xpfrom, " > ", df$xpto,
            "\n- raw: ", df$ypfrom, " > ", df$ypto)
        df$sig_label <- as.factor(paste0(
            ifelse(filt_nonsig[ifrom],"filt.",""), 
            ifelse(df$xpfrom<p_t1,"","in"),"sig>",
            ifelse(filt_nonsig[ito],"filt.",""), 
            ifelse(df$xpto<p_t1,"","in"),"sig / ",
            ifelse(df$ypfrom<p_t2,"","in"),"sig>",
            ifelse(df$ypto<p_t2,"","in"),"sig"))
        
        # for (absolute in c(TRUE, FALSE)) {
        #     for (logged in c(TRUE, FALSE)) {
        # dfa <- df
        
        # if (logged) {
        df$x <- log(df$xpto,10) - log(df$xpfrom,10)
        df$x_ <- log(df$xpto_,10) - log(df$xpfrom_,10)
        df$y <- log(df$ypto,10) - log(df$ypfrom,10)
        df$z <- log(pp0$values,10)
        # } else {
        #     dfa$x <- pp1$values[ito]-pp1$values[ifrom]
        #     dfa$y <- pp2$values[ito]-pp2$values[ifrom]
        # }
        # if (absolute) {
        #     dfa$x <- abs(dfa$x)
        #     dfa$y <- abs(dfa$y)
        # }
        
        
        #for (lyrs in list(c(0,0), c(1,1),c(2,2),c(3,3),c(4,4), c(1,4))) {
        lyrs = c(0,0)    
        l2 <- lyrs[2]
        l1 <- lyrs[1]
        l_inds <- df$phenolayer >= l1 & df$phenolayer <= l2
        if (sum(lyrs)==0) l_inds <- good_count_
        
        qp <- ggplot2::ggplot(df[l_inds,], ggplot2::aes(
            x=x,y=eprop_change, colour=phenolayer,
            size=mean_count, alpha=.3, stroke=1, shape=sig_label)) +
            ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
            ggplot2::geom_abline(intercept=0, slope=1) +
            ggplot2::ggtitle(paste0(ifelse(
                absolute,"absolute ",""),
                "difference between child and parent ",
                ifelse(logged,"-log10 ",""),"p-values")) +
            ggplot2::labs(
                x="SpecEnr p-value difference on edges",
                y="layer",
                col="layer",
                size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
            ggplot2::geom_point(ggplot2::aes(shape=sig_label)) +
            ggplot2::scale_colour_gradientn(
                colours=c('blue','cyan','yellow','red'))
        
        ggplot2::ggsave(paste0(
            plot_path_,"/SpecEnrVSpropdiff", 
            ifelse(absolute,"_abs",""), 
            ifelse(logged,"_log10",""), 
            "_fromLayer", l2,"-to-",l1,".png"), 
            plot=qp, scale=1, width=5, height=5,
            units="in", dpi=500, limitsize=TRUE)
        
        qp <- ggplot2::ggplot(df[l_inds,], ggplot2::aes(
            x=y,y=eprop_change, colour=phenolayer,
            size=mean_count, alpha=.3,stroke=1)) +
            ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
            ggplot2::geom_abline(intercept=0, slope=1) +
            ggplot2::ggtitle(paste0(ifelse(
                absolute,"absolute ",""),
                "difference between child and parent ",
                ifelse(logged,"-log10 ",""),"p-values")) +
            ggplot2::labs(
                x="raw p-value difference on edges",
                y="layer",
                col="layer",
                size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
            ggplot2::geom_point(ggplot2::aes(shape=sig_label)) +
            ggplot2::scale_colour_gradientn(
                colours=c('blue','cyan','yellow','red'))
        
        ggplot2::ggsave(paste0(
            plot_path_,"/rawVSpropdiff", 
            ifelse(absolute,"_abs",""), 
            ifelse(logged,"_log10",""), 
            "_fromLayer", l2,"-to-",l1,".png"), 
            plot=qp, scale=1, width=5, height=5,
            units="in", dpi=500, limitsize=TRUE)
        
        sigv <- c("all","insig","sig")
        sig_combos_ <- rbind(c(0,0),expand.grid(c(1,2), c(1,2)))
        zero_combos <- matrix(0,ncol=2,nrow=nrow(sig_combos_))
        sg1 <- cbind(sig_combos_,zero_combos)
        sg2 <- cbind(zero_combos[-1,],sig_combos_[-1,])
        sig_combos <- rbind(as.matrix(sg1),as.matrix(sg2))
        # sig_combos <- expand.grid(c(0,1,2), c(0,1,2), c(0,1,2), c(0,1,2))
        paths_ <-  apply(sig_combos, 1, function(sg) {
            sg <- unlist(sg)
            paste0(
                plot_path_,"/SpecEnrVSraw", 
                ifelse(absolute,"_abs",""), 
                ifelse(logged,"_log10",""), 
                "_fromLayer", l2,"-to-",l1,
                "_SpecEnr-",sigv[sg[1]+1], "FROM-",sigv[sg[2]+1], 
                "TO_raw-", sigv[sg[3]+1], "FROM-",sigv[sg[4]+1], 
                "TO.png")
        })
        inds_ <- apply(sig_combos, 1, function(sg) {
            # pp1 and pp2, from and to: 
            # 0 means any, 1 means insig, 2 means sig
            sg <- unlist(sg)
            f_inds <- l_inds
            if (sg[1]==1) f_inds <- !pp1sig[ifrom] & f_inds
            if (sg[1]==2) f_inds <- pp1sig[ifrom] & f_inds
            if (sg[2]==1) f_inds <- !pp1sig[ito] & f_inds
            if (sg[2]==2) f_inds <- pp1sig[ito] & f_inds
            if (sg[3]==1) f_inds <- !pp2sig[ifrom] & f_inds
            if (sg[3]==2) f_inds <- pp2sig[ifrom] & f_inds
            if (sg[4]==1) f_inds <- !pp2sig[ito] & f_inds
            if (sg[4]==2) f_inds <- pp2sig[ito] & f_inds
            return(f_inds)
            
            
            a <- df[f_inds,]
            qp <- ggplot2::ggplot(a) + 
                ggiraph::geom_point_interactive(ggplot2::aes(
                    x=x,y=y, colour=phenolayer, size=mean_count,
                    alpha=.3,stroke=1, tooltip=label_long)) +
                ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
                ggplot2::geom_abline(intercept=0, slope=1) +
                ggplot2::ggtitle(paste0("(",sum(f_inds),")", ifelse(
                    absolute,"absolute ",""),
                    "difference between child and parent ",
                    ifelse(logged,"-log10 ",""),"p-values")) +
                ggplot2::labs(
                    x="SpecEnr p-value difference on edges",
                    y="cells_ul_blood/prop p-value difference on edges",
                    col="layer",
                    size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
                ggplot2::scale_colour_gradientn(
                    colours=c('blue','cyan','yellow','red'))
            
            ggiraph::girafe(ggobj=qp)
        })
        inds_bad <- apply(inds_, 2, sum)==0
        inds_istr <- apply(inds_[,!inds_bad], 2, paste, collapse="")
        inds_i_ <- union(which(inds_bad),
                         which(!inds_bad)[duplicated(inds_istr)])
        # a <- sapply(paths_[inds_i_], file.remove)
        
        inds_good <- setdiff(seq_len(ncol(inds_)),inds_i_)
        inds_z <- apply(sig_combos, 1, function(sg) {
            # pp1 and pp2, from and to: 
            # 0 means any, 1 means insig, 2 means sig
            sg <- unlist(sg)
            f_inds <- l_inds
            if (sg[1]==1) f_inds <- !pp0sig & f_inds
            if (sg[1]==2) f_inds <- pp0sig & f_inds
            if (sg[2]==1) f_inds <- !pp0sig & f_inds
            if (sg[2]==2) f_inds <- pp0sig & f_inds
            if (sg[3]==1) f_inds <- !pp2sig[ifrom] & f_inds
            if (sg[3]==2) f_inds <- pp2sig[ifrom] & f_inds
            if (sg[4]==1) f_inds <- !pp2sig[ito] & f_inds
            if (sg[4]==2) f_inds <- pp2sig[ito] & f_inds
            return(f_inds)
        })
        
        # if (length(inds_good)>0)
        a <- sapply(1:nrow(sig_combos), function(i) {
            if (sum(inds_[,i])>0) {
                qp <- ggplot2::ggplot(df[inds_[,i],], ggplot2::aes(
                    x=x,y=y, colour=phenolayer,
                    size=mean_count)) +
                    ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
                    ggplot2::geom_abline(intercept=0, slope=1) +
                    ggplot2::ggtitle(paste0("(",sum(inds_[,i]),")", ifelse(
                        absolute,"absolute ",""),
                        "difference between child and parent ",
                        ifelse(logged,"-log10 ",""),"p-values")) +
                    ggplot2::labs(
                        x="SpecEnr p-value difference on edges",
                        y="cells_ul_blood/prop p-value difference on edges",
                        col="layer",
                        size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
                    ggplot2::scale_colour_gradientn(
                        colours=c('blue','cyan','yellow','red'))
                
                if (interactive) {
                    qp <- qp +
                        ggiraph::geom_point_interactive(
                            ggplot2::aes(
                                tooltip=label_long, alpha=.1, stroke=1))
                    htmlwidgets::saveWidget(
                        ggiraph::girafe(ggobj=qp),
                        gsub("png","html",paths_[i]))
                    # ggiraph::girafe(ggobj=qp)
                } else {
                    qp <- qp +
                        ggplot2::geom_point(
                            stroke=1, ggplot2::aes(shape=sig_label))
                    ggplot2::ggsave(
                        paths_[i], plot=qp, scale=1, width=8, height=6,
                        units="in", dpi=500, limitsize=TRUE)
                }
                
                qp <- ggplot2::ggplot(df[inds_[,i],], ggplot2::aes(
                    x=x_,y=y, colour=phenolayer,
                    size=mean_count)) +
                    ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
                    ggplot2::geom_abline(intercept=0, slope=1) +
                    ggplot2::ggtitle(paste0("(",sum(inds_[,i]),")", ifelse(
                        absolute,"absolute ",""),
                        "difference between child and parent ",
                        ifelse(logged,"-log10 ",""),"p-values")) +
                    ggplot2::labs(
                        x="SpecEnr p-value difference on edges",
                        y="cells_ul_blood/prop p-value difference on edges",
                        col="layer",
                        size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
                    ggplot2::scale_colour_gradientn(
                        colours=c('blue','cyan','yellow','red'))
                
                if (interactive) {
                    qp <- qp +
                        ggiraph::geom_point_interactive(
                            ggplot2::aes(
                                tooltip=label_long, alpha=.1, stroke=1,
                                shape=sig_label))
                    htmlwidgets::saveWidget(
                        ggiraph::girafe(ggobj=qp),
                        gsub("[.]png","_.html",paths_[i]))
                } else {
                    qp <- qp +
                        ggplot2::geom_point(
                            stroke=1, ggplot2::aes(shape=sig_label))
                    ggplot2::ggsave(
                        gsub("[.]png","_.png",paths_[i]), 
                        plot=qp, scale=1, width=8, height=6,
                        units="in", dpi=500, limitsize=TRUE)
                }

            }
            
            if (sum(inds_z[,i])>0 & sig_combos[i,2]==0) {
                # edge comparison
                qp <- ggplot2::ggplot(df[inds_z[,i],], ggplot2::aes(
                    x=z,y=y, colour=phenolayer,
                    size=mean_count)) +
                    ggplot2::scale_shape_manual(values=1:nlevels(df$sig_label))+
                    ggplot2::geom_abline(intercept=0, slope=1) +
                    ggplot2::ggtitle(paste0(
                        "(",sum(inds_[,i]),")", ifelse(
                            absolute,"absolute ",""),
                        "difference between child and parent ",
                        ifelse(logged,"-log10 ",""),"p-values")) +
                    ggplot2::labs(
                        x="SpecEnr p-value on edges",
                        y="cells_ul_blood/prop p-value difference on edges",
                        col="layer",
                        size="count mean (to)",
                shape="significance (SpecEnr/raw)") +
                    ggplot2::scale_colour_gradientn(
                        colours=c('blue','cyan','yellow','red'))
                
                if (interactive) {
                    qp <- qp +
                        ggiraph::geom_point_interactive(
                            ggplot2::aes(
                                tooltip=label_long, alpha=.1,
                                stroke=1, shape=sig_label))
                    htmlwidgets::saveWidget(
                        ggiraph::girafe(ggobj=qp),
                        gsub("[.]png","_edge.html",paths_[i]))
                } else {
                    qp <- qp +
                        ggplot2::geom_point(
                            stroke=1, ggplot2::aes(shape=sig_label))
                    ggplot2::ggsave(
                        gsub("[.]png","_edge.png",paths_[i]), 
                        plot=qp, scale=1, width=8, height=6,
                        units="in", dpi=500, limitsize=TRUE)
                }
                
            }
            
            
        })
        #}
        #     }
        # }
    }) }
    flowGraph:::time_output(start1)
}
```




## Cell hierarchy plots (experimental)

```{r plots_feature, eval=FALSE, message=FALSE, include=FALSE, echo=FALSE}
start1 = Sys.time()
result_dirs = list.dirs(paste0(root,"/results"), recursive=FALSE)
for (result_dir in result_dirs) {
    # if (!grepl("pos",result_dir)) next
    start1 = Sys.time()
    cat(result_dir,"\n")
    
    fg = get(load(paste0(result_dir,"/fg.Rdata")))
    
    for (cls in unique(fg@meta$class)) {
        try ({
            if (cls=="control") next
            path_ = paste0(result_dir,"/plots/cell_hierarchy/temp/control_",cls)
            dir.create(path_, recursive=TRUE, showWarnings=FALSE)
            gr <- fg_plot(fg, type="node", p_thres=.01, show_bgedges=TRUE)
            
            mse = as.matrix(fg_get_feature(fg, "node","SpecEnr"))
            mse_c = colMeans(mse[fg_get_meta(fg)$class=="control",])
            mse_m = colMeans(mse[fg_get_meta(fg)$class==cls,])
            mse_ = mse_m - mse_c
            mep = as.matrix(fg_get_feature(fg, "node","expect_prop"))
            mep_c = colMeans(mep[fg_get_meta(fg)$class=="control",])
            mep_m = colMeans(mep[fg_get_meta(fg)$class==cls,])
            mpp = as.matrix(fg_get_feature(fg, "node","prop"))
            mpp_c = colMeans(mpp[fg_get_meta(fg)$class=="control",])
            mpp_m = colMeans(mpp[fg_get_meta(fg)$class==cls,])
            mpp_ = mpp_m-mpp_c
            
            p = fg_get_summary(fg, type="node", summary_meta=list(
                feature="SpecEnr", test_name="t_byLayer_diminish", class="class",
                cls_labels=paste0("control_",cls)))$values
            p[mpp_<.001] = 1
            p_ = p<0.01
            pparen = fg@edge_list$parent
            pchild = fg@edge_list$child
            
            
            gr$v$label = sapply(seq_len(length(mse_m)), function(j)
                gsub("[:]",paste0(": ",round(mse_c[j],3),"/",
                                  round(mse_m[j],3)),gr$v$label[j]))
            
            gr$v$colour = gr$v$size = mse_
            
            gp = gggraph(gr)
            ggplot2::ggsave(paste0(path_,"/SpecEnr.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            
            
            # difference between its most similar sibling pops with same markers
            sediff = rep(0,length(mse_))
            names(sediff) = names(mse_)
            sediff__ = sediff_ = sediff
            
            sediffthres = .01
            
            # get unique difference specenr for each marker set
            # pcind = gr$v$phenotype%in%names(pchild)
            lyrs = unique(gr$v$phenolayer)
            lyrsl = map(lyrs, function(l) gr$v$phenolayer==l)
            names(lyrsl) = as.character(lyrs)
            
            levi_0 = which(p_)
            if (length(levi_0)==0) next
            levi_0_mrks = gsub("[+-]","",names(levi_0))
            for (mrks in unique(levi_0_mrks)) {
                mrki_1 = which(levi_0_mrks==mrks)
                if (length(mrki_1)==1 | nchar(mrks)==1) {
                    sediff[levi_0[mrki_1]] = 
                        sediff_[levi_0[mrki_1]] = 
                        sediff__[levi_0[mrki_1]] = 1
                    next
                }
                diffsi = unlist(purrr::map(
                    seq_len(length(mrki_1)), function(mi) {
                        min(abs(mse_[levi_0[mrki_1[mi]]] -
                                    mse_[levi_0[mrki_1[-mi]]]))
                    }))
                sediff[levi_0[mrki_1]] = diffsi/max(diffsi)
                if (max(diffsi)<sediffthres)  # BETTTER IF THERES A THRESHOLD
                    sediff[levi_0[mrki_1]] = 0
                
                sediff_[levi_0[mrki_1]] = sediff[levi_0[mrki_1]]
                se_dup = duplicated(sediff_[levi_0[mrki_1]]) | 
                    duplicated(sediff_[levi_0[mrki_1]], fromLast=T)
                sediff_[levi_0[mrki_1[se_dup]]] = 0
                
                diffsi = unlist(purrr::map(
                    seq_len(length(mrki_1)), function(mi) {
                        min(abs(mpp_[levi_0[mrki_1[mi]]] -
                                    mpp_[levi_0[mrki_1[-mi]]]))
                    }))
                sediff__[levi_0[mrki_1]] = diffsi/max(diffsi)
                if (max(diffsi)<sediffthres)  # BETTTER IF THERES A THRESHOLD
                    sediff__[levi_0[mrki_1]] = 0
            }
            scdiff = spdiff = sediff
            
            # plot_ly(data.frame(y=sort(sediff)), 
            #         x=seq_len(length(sediff)), y=~y,
            #         text=names(sediff)[order(sediff)], label=text)
            
            gr$v$size = sediff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = sediff > sediffthres# & smdiff < .01
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) of nodes with same markers.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            gr$v$size = sediff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = sediff_ > sediffthres# & smdiff < .01
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) of nodes with same markers WITH NO DUPLICATES.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk_.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            gr$v$size = sediff__ #abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = sediff__ > sediffthres# & smdiff < .01
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating prop (exp-0) of nodes with same markers.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrkprop.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            gr$v$size = sediff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = sediff > sediffthres & # & smdiff < .01
                sediff__ > sediffthres
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) AND prop of nodes with same markers.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrkORprop.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            
            # parent must not repeat
            ppind = gr$v$phenotype%in%names(pparen)
            for (lev in c(sort(unique(gr$v$phenolayer), decreasing=TRUE)[-1], 0)) {
                levi_0_ = which(p_ & sediff > sediffthres & 
                                    lyrsl[[as.character(lev+1)]] & ppind)
                levi_0 = which(p_ & sediff > sediffthres & 
                                   lyrsl[[as.character(lev)]] & ppind)
                if ((lev>0 & length(levi_0)==0) | length(levi_0_)==0) next
                for (chld in names(levi_0_)) {
                    prnt_1 = which(names(levi_0)%in%pparen[[chld]])
                    if (length(prnt_1)==1) {
                        spdiff[levi_0[prnt_1]] = 1
                    } else {
                        diffsp = unlist(purrr::map(
                            seq_len(length(prnt_1)), function(mi) {
                                min(abs(mse_[levi_0[prnt_1[mi]]] -
                                            mse_[levi_0[prnt_1[-mi]]]))
                            }))
                        spdiff[levi_0[prnt_1]] = diffsp/max(diffsp)
                        if (max(diffsp)<sediffthres) # BETTTER IF THERES A THRESHOLD
                            spdiff[levi_0[prnt_1]] = 0
                    }
                }
            }
            
            # plot_ly(data.frame(y=sort(spdiff)), 
            #         x=seq_len(length(spdiff)), y=~y,
            #         text=names(spdiff)[order(spdiff)], label=text)
            
            # parent must not repeat
            pcind = gr$v$phenotype%in%names(pchild)
            for (lev in sort(unique(gr$v$phenolayer), decreasing=FALSE)[-1]) {
                levi_0_ = which(p_ & sediff > sediffthres & 
                                    lyrsl[[as.character(lev-1)]] & pcind)
                levi_0 = which(p_ & sediff > sediffthres & 
                                   lyrsl[[as.character(lev)]] & pcind)
                if (length(levi_0)==0 | length(levi_0_)==0) next
                for (prnt in names(levi_0_)) {
                    chld_1 = which(names(levi_0)%in%pchild[[prnt]])
                    if (length(chld_1)==1) {
                        scdiff[levi_0[chld_1]] = 1
                    } else {
                        diffsc = unlist(purrr::map(
                            seq_len(length(chld_1)), function(mi) {
                                min(abs(mse_[levi_0[chld_1[mi]]] -
                                            mse_[levi_0[chld_1[-mi]]]))
                            }))
                        scdiff[levi_0[chld_1]] = diffsc/max(diffsc)
                        if (max(diffsc)<sediffthres) # BETTTER IF THERES A THRESHOLD
                            scdiff[levi_0[chld_1]] = 0
                    }
                }
            }
            
            # plot_ly(data.frame(y=sort(scdiff)), 
            #         x=seq_len(length(scdiff)), y=~y,
            #         text=names(scdiff)[order(scdiff)], label=text)
            
            # cpop="A+B+"; c(mep_m[cpop],
            #                sum(max(mep_m[pchild[[cpop]]]),
            #                    min(mep_m[pchild[[cpop]]])),
            #                mep_m[pchild[[cpop]]]) # same for nonsigs
            # cpop="A+B+C+"; c(mep_m[cpop],
            #                mep_m[pparen[[cpop]]]-mep_m[cpop])
            # 
            # cpop="A+B+"; c(mse_[cpop],
            #                mse_[pchild[[cpop]]]) # same for nonsigs
            # cpop="A+B+C+"; c(mse_[cpop],
            #                mse_[pparen[[cpop]]])
            
            gr$v$size = spdiff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = spdiff > sediffthres# & smdiff < .01
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) of nodes with same markers and of nodes who are parent(s) of a single node.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk_par.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            
            gr$v$size = scdiff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = scdiff > sediffthres# & smdiff < .01
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) of nodes with same markers and of nodes who are child(s) of a single node.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk_chld.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            gr$v$size = scdiff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = scdiff > sediffthres & spdiff > sediffthres &
                sediff > sediffthres & sediff__ > sediffthres
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr (exp-0) of nodes with same markers and of nodes who are child(s) (& parent(s)) of a single node.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk_chldANDpar_prop.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            gr$v$size = scdiff#abs(exp_m-exp_c)
            gr$v$label_ind = gr$v$v_ind = scdiff > sediffthres & spdiff > sediffthres
            gp = gggraph(gr, main="Feature: SpecEnr\nClass: class - control_exp\nsummary statistic: t_byLayer (threshold: 0)\nNode colour: SpecEnr difference between control and experiment\nNode size: non-repeating SpecEnr & prop (exp-0) of nodes with same markers and nodes with same child(s) (& parent(s)) of a single node.\nLabel(s): SpecEnr (exp-0), node, expect_prop (prop)")
            ggplot2::ggsave(paste0(path_,"/SpecEnr_mrk_chldANDpar.png"),
                            plot=gp, scale=1, width=10, height=9,
                            units="in", dpi=500, limitsize=TRUE)
            
            # gr = fg_plot(
            #     fg, sum_plot=TRUE,
            #     class="class", test_name="t_byLayer",
            #     cls_label1="control", cls_label2=cls,
            #     node_feature="SpecEnr", edge_feature="prop",
            #     label1=NULL, label2=NULL, # node only
            #     p_thres=.05, show_bgedges=TRUE,
            #     path=paste0(path_,"/SpecEnr_t_byLayer_SpecEnr.png"))
            
        })
    }
    
}  
time_output(start1)
```


# custom plots for each data set

```{r}

# flowcap_6 -- show these labels
c("FS+CD117+CD34+CD38-", "CD45-CD34+","CD45+CD34-", "CD117+CD45+", "FS-CD45-CD38+", "FS-CD117+CD45-CD38+",  "FS-CD117+CD45-CD34+CD38+")

```









# References
